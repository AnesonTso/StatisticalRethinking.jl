<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6.2s · StatisticalRethinking.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>StatisticalRethinking.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><a class="toctext" href="../../layout/">Layout</a></li><li><a class="toctext" href="../../acknowledgements/">Acknowledgements</a></li><li><a class="toctext" href="../../references/">References</a></li><li><span class="toctext">Chapter 00</span><ul><li><a class="toctext" href="../../00/clip-01-03/">clip-01-03</a></li><li><a class="toctext" href="../../00/clip-04-05/">clip-04-05</a></li></ul></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/clip-01-02/">clip-01-02</a></li><li><a class="toctext" href="../../02/clip-03-05/">clip-03-05</a></li><li><a class="toctext" href="../../02/clip-06-07/">clip-06-07</a></li><li><a class="toctext" href="../../02/clip-08m/">clip-08m</a></li><li><a class="toctext" href="../../02/clip-08s/">clip-08s</a></li></ul></li><li><span class="toctext">Chapter 03</span><ul><li><a class="toctext" href="../../03/clip-01/">clip-01</a></li><li><a class="toctext" href="../../03/clip-02-05/">clip-02-05</a></li><li><a class="toctext" href="../../03/clip-05s/">clip-05s</a></li><li><a class="toctext" href="../../03/clip-06-16s/">clip-06-16s</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1s/">m4.1s</a></li><li><a class="toctext" href="../../04/m4.2s/">m4.2s</a></li><li><a class="toctext" href="../../04/m4.3s/">m4.3s</a></li><li><a class="toctext" href="../../04/m4.4s/">m4.4s</a></li><li><a class="toctext" href="../../04/clip-01-06/">clip-01-06</a></li><li><a class="toctext" href="../../04/clip-07-13s/">clip-07-13s</a></li><li><a class="toctext" href="../../04/clip-14-20/">clip-14-20</a></li><li><a class="toctext" href="../../04/clip-21-29s/">clip-21-29s</a></li><li><a class="toctext" href="../../04/clip-30s/">clip-30s</a></li><li><a class="toctext" href="../../04/clip-38s/">clip-38s</a></li><li><a class="toctext" href="../../04/clip-43s/">clip-43s</a></li><li><a class="toctext" href="../../04/clip-45-47s/">clip-45-47s</a></li><li><a class="toctext" href="../../04/clip-48-54s/">clip-48-54s</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/clip-01s/">clip-01s</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1/">m8.1</a></li><li><a class="toctext" href="../../08/m8.3/">m8.3</a></li></ul></li><li><span class="toctext">Chapter 10</span></li><li><span class="toctext">Chapter 11</span></li><li><span class="toctext">Chapter 12</span><ul><li><a class="toctext" href="../m12.6.1s/">m12.6.1s</a></li><li class="current"><a class="toctext" href>m12.6.2s</a><ul class="internal"></ul></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6.2s</a></li></ul><a class="edit-page" href="https://github.com/StanJulia/StatisticalRethinking.jl/blob/master/scripts/12/m12.6.2s.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6.2s</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using StatisticalRethinking
using CmdStan, StanMCMCChain

ProjDir = rel_path(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

d = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(d) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col log_pop, set log() for population data</p><div><pre><code class="language-julia">d[:log_pop] = map((x) -&gt; log(x), d[:population]);
d[:society] = 1:10;

first(d, 5)

m12_6 = &quot;
  data {
    int N;
    int T[N];
    int N_societies;
    int society[N];
    int P[N];
  }
  parameters {
    real alpha;
    vector[N_societies] a_society;
    real bp;
    real&lt;lower=0&gt; sigma_society;
  }
  model {
    vector[N] mu;
    target += normal_lpdf(alpha | 0, 10);
    target += normal_lpdf(bp | 0, 1);
    target += cauchy_lpdf(sigma_society | 0, 1);
    target += normal_lpdf(a_society | 0, sigma_society);
    for(i in 1:N) mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
    target += poisson_log_lpmf(T | mu);
  }
  generated quantities {
    vector[N] log_lik;
    {
    vector[N] mu;
    for(i in 1:N) {
      mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
      log_lik[i] = poisson_log_lpmf(T[i] | mu[i]);
    }
    }
  }
&quot;;</code></pre></div><p>Define the Stanmodel and set the output format to :mcmcchain.</p><div><pre><code class="language-julia">stanmodel = Stanmodel(name=&quot;m12.6&quot;,  model=m12_6, output_format=:mcmcchain);</code></pre><pre><code class="language-none">=====&gt; /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12


File /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan will be updated.</code></pre></div><p>Input data for cmdstan</p><div><pre><code class="language-julia">m12_6_data = Dict(&quot;N&quot; =&gt; size(d, 1), &quot;T&quot; =&gt; d[:total_tools], &quot;N_societies&quot; =&gt; 10, &quot;society&quot; =&gt; d[:society], &quot;P&quot; =&gt; d[:population]);</code></pre></div><p>Sample using cmdstan</p><div><pre><code class="language-julia">rc, chn, cnames = stan(stanmodel, m12_6_data, ProjDir, diagnostics=false, summary=false, CmdStanDir=CMDSTAN_HOME);</code></pre><pre><code class="language-none">

--- Translating Stan model to C++ code ---
bin/stanc  /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan --o=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp
Model name=m12_6_model
Input file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan
Output file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp

--- Linking C++ model ---
g++ -Wall -I . -isystem stan/lib/stan_math/lib/eigen_3.3.3 -isystem stan/lib/stan_math/lib/boost_1.66.0 -isystem stan/lib/stan_math/lib/sundials_3.1.0/include -std=c++1y -DBOOST_RESULT_OF_USE_TR1 -DBOOST_NO_DECLTYPE -DBOOST_DISABLE_ASSERTS -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION -Wno-unused-function -Wno-uninitialized -I src -isystem stan/src -isystem stan/lib/stan_math/ -DFUSION_MAX_VECTOR_SIZE=12 -Wno-unused-local-typedefs -DEIGEN_NO_DEBUG -DNO_FPRINTF_OUTPUT -pipe   src/cmdstan/main.cpp  -O3 -o /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6 -include /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_nvecserial.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_cvodes.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_idas.a
Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:


Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre></div><p>Describe the draws</p><div><pre><code class="language-julia">describe(chn)</code></pre><pre><code class="language-none">Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                   Mean          SD         Naive SE       MCSE         ESS
         lp__ -39.473020450  2.924830009 0.04624562299 0.0926625187  996.306718
accept_stat__   0.940005141  0.084018673 0.00132845187 0.0021406526 1000.000000
   stepsize__   0.048348450  0.004349115 0.00006876554 0.0006963287   39.009752
  treedepth__   5.931750000  0.456227984 0.00721359781 0.0195227924  546.109798
 n_leapfrog__  75.697000000 34.581630431 0.54678358683 1.5195383155  517.925888
  divergent__   0.000000000  0.000000000 0.00000000000 0.0000000000         NaN
     energy__  45.982339900  3.794529660 0.05999678188 0.1199935393 1000.000000
        alpha   1.118218713  0.734193295 0.01160861528 0.0231385203 1000.000000
  a_society.1  -0.203885246  0.245382906 0.00387984440 0.0062612836 1000.000000
  a_society.2   0.039344481  0.211288121 0.00334075853 0.0042641119 1000.000000
  a_society.3  -0.047308764  0.188981633 0.00298806197 0.0043169263 1000.000000
  a_society.4   0.322616357  0.182980918 0.00289318234 0.0041756866 1000.000000
  a_society.5   0.040864352  0.170178574 0.00269075952 0.0035325151 1000.000000
  a_society.6  -0.320185064  0.201730136 0.00318963352 0.0042546572 1000.000000
  a_society.7   0.144516883  0.170692094 0.00269887898 0.0043006695 1000.000000
  a_society.8  -0.169553564  0.178195154 0.00281751277 0.0038892819 1000.000000
  a_society.9   0.275415780  0.173268984 0.00273962319 0.0047389279 1000.000000
 a_society.10  -0.089801389  0.280217109 0.00443062151 0.0090760006  953.235618
           bp   0.259182208  0.079235052 0.00125281618 0.0025717614  949.234110
sigma_society   0.307198087  0.119595070 0.00189096409 0.0034367105 1000.000000
    log_lik.1  -2.796976257  0.754401282 0.01192813161 0.0147911789 1000.000000
    log_lik.2  -2.811734753  0.490105420 0.00774924710 0.0107128284 1000.000000
    log_lik.3  -2.856226230  0.497139705 0.00786046891 0.0102925292 1000.000000
    log_lik.4  -3.550360522  0.922177597 0.01458090806 0.0204979697 1000.000000
    log_lik.5  -3.035978885  0.523688724 0.00828024576 0.0114141779 1000.000000
    log_lik.6  -3.152114988  0.902364096 0.01426762911 0.0216697593 1000.000000
    log_lik.7  -3.217761705  0.609149790 0.00963150387 0.0129500673 1000.000000
    log_lik.8  -3.050002642  0.626785177 0.00991034382 0.0110866536 1000.000000
    log_lik.9  -3.548816430  0.818829436 0.01294683017 0.0210271882 1000.000000
   log_lik.10  -3.521766958  0.644380642 0.01018855254 0.0137529339 1000.000000

Quantiles:
                   2.5%         25.0%         50.0%        75.0%         97.5%
         lp__ -46.003447500 -41.199050000 -39.25130000 -37.393050000 -34.49215000
accept_stat__   0.697429300   0.917668500   0.97534800   0.995703750   0.99996600
   stepsize__   0.042190200   0.045450375   0.04885660   0.051754675   0.05349040
  treedepth__   5.000000000   6.000000000   6.00000000   6.000000000   7.00000000
 n_leapfrog__  31.000000000  63.000000000  63.00000000  63.000000000 127.00000000
  divergent__   0.000000000   0.000000000   0.00000000   0.000000000   0.00000000
     energy__  39.387575000  43.293250000  45.68465000  48.247675000  54.32676500
        alpha  -0.381767900   0.663635750   1.13625000   1.592320000   2.55858450
  a_society.1  -0.751618475  -0.349851500  -0.18634350  -0.042445350   0.24528005
  a_society.2  -0.362839900  -0.095296300   0.03691260   0.167850500   0.46957237
  a_society.3  -0.414796650  -0.171126500  -0.04411585   0.073132575   0.33194860
  a_society.4  -0.004690437   0.192485250   0.31458950   0.442213500   0.70501260
  a_society.5  -0.292305450  -0.069710650   0.03788075   0.149567000   0.39157435
  a_society.6  -0.747258050  -0.449645500  -0.30930500  -0.178694000   0.03398342
  a_society.7  -0.180992950   0.028917175   0.14090450   0.254902000   0.48676702
  a_society.8  -0.541252450  -0.284688250  -0.16076200  -0.049263100   0.16798328
  a_society.9  -0.046463505   0.156659500   0.26698000   0.391036000   0.62707105
 a_society.10  -0.673616375  -0.253625750  -0.08515065   0.081941150   0.46118098
           bp   0.105576075   0.208153500   0.25874150   0.308769250   0.42126553
sigma_society   0.126668900   0.221455500   0.29028200   0.371730500   0.59277388
    log_lik.1  -4.857075000  -3.038790000  -2.50457500  -2.271312500  -2.20853975
    log_lik.2  -4.226001250  -2.915080000  -2.62402500  -2.500012500  -2.46863975
    log_lik.3  -4.212566000  -2.966342500  -2.66639000  -2.544617500  -2.51184950
    log_lik.4  -6.049267000  -3.877362500  -3.20477500  -2.889122500  -2.80234975
    log_lik.5  -4.550146250  -3.148842500  -2.83682500  -2.706335000  -2.67007975
    log_lik.6  -5.666172000  -3.473772500  -2.82814000  -2.505775000  -2.39648975
    log_lik.7  -5.001237250  -3.388677500  -2.98227000  -2.814967500  -2.76575000
    log_lik.8  -4.733985750  -3.214812500  -2.82024000  -2.638750000  -2.58855975
    log_lik.9  -5.953201500  -3.788440000  -3.23343000  -2.989845000  -2.92465975
   log_lik.10  -5.208981250  -3.683245000  -3.27465500  -3.101762500  -3.05199000</code></pre></div><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../m12.6.1s/"><span class="direction">Previous</span><span class="title">m12.6.1s</span></a><a class="next" href="../../"><span class="direction">Next</span><span class="title">Functions</span></a></footer></article></body></html>
