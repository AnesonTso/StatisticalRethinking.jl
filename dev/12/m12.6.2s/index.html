<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6.2s · StatisticalRethinking.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>StatisticalRethinking.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><a class="toctext" href="../../layout/">Layout</a></li><li><a class="toctext" href="../../acknowledgements/">Acknowledgements</a></li><li><a class="toctext" href="../../references/">References</a></li><li><span class="toctext">Chapter 00</span><ul><li><a class="toctext" href="../../00/clip-01-03/">clip-01-03</a></li><li><a class="toctext" href="../../00/clip-04-05/">clip-04-05</a></li></ul></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/clip-01-02/">clip-01-02</a></li><li><a class="toctext" href="../../02/clip-03-05/">clip-03-05</a></li><li><a class="toctext" href="../../02/clip-06-07/">clip-06-07</a></li><li><a class="toctext" href="../../02/clip-08s/">clip-08s</a></li><li><a class="toctext" href="../../02/clip-08t/">clip-08t</a></li></ul></li><li><span class="toctext">Chapter 03</span><ul><li><a class="toctext" href="../../03/clip-01/">clip-01</a></li><li><a class="toctext" href="../../03/clip-02-05/">clip-02-05</a></li><li><a class="toctext" href="../../03/clip-05s/">clip-05s</a></li><li><a class="toctext" href="../../03/clip-06-16s/">clip-06-16s</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1s/">m4.1s</a></li><li><a class="toctext" href="../../04/m4.2s/">m4.2s</a></li><li><a class="toctext" href="../../04/m4.2t/">m4.2t</a></li><li><a class="toctext" href="../../04/m4.3s/">m4.3s</a></li><li><a class="toctext" href="../../04/m4.4s/">m4.4s</a></li><li><a class="toctext" href="../../04/clip-01-06/">clip-01-06</a></li><li><a class="toctext" href="../../04/clip-07-13s/">clip-07-13s</a></li><li><a class="toctext" href="../../04/clip-14-20/">clip-14-20</a></li><li><a class="toctext" href="../../04/clip-21-23/">clip-21-23</a></li><li><a class="toctext" href="../../04/clip-24-29s/">clip-24-29s</a></li><li><a class="toctext" href="../../04/clip-30s/">clip-30s</a></li><li><a class="toctext" href="../../04/clip-38s/">clip-38s</a></li><li><a class="toctext" href="../../04/clip-43s/">clip-43s</a></li><li><a class="toctext" href="../../04/clip-45-47s/">clip-45-47s</a></li><li><a class="toctext" href="../../04/clip-48-54s/">clip-48-54s</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/clip-01s/">clip-01s</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1/">m8.1</a></li><li><a class="toctext" href="../../08/m8.3/">m8.3</a></li></ul></li><li><span class="toctext">Chapter 10</span></li><li><span class="toctext">Chapter 11</span></li><li><span class="toctext">Chapter 12</span><ul><li><a class="toctext" href="../m12.6.1s/">m12.6.1s</a></li><li class="current"><a class="toctext" href>m12.6.2s</a><ul class="internal"></ul></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6.2s</a></li></ul><a class="edit-page" href="https://github.com/StanJulia/StatisticalRethinking.jl/blob/master/scripts/12/m12.6.2s.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6.2s</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using StatisticalRethinking
using CmdStan, StanMCMCChain

ProjDir = rel_path(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

d = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(d) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col log_pop, set log() for population data</p><div><pre><code class="language-julia">d[:log_pop] = map((x) -&gt; log(x), d[:population]);
d[:society] = 1:10;

first(d, 5)

m12_6 = &quot;
  data {
    int N;
    int T[N];
    int N_societies;
    int society[N];
    int P[N];
  }
  parameters {
    real alpha;
    vector[N_societies] a_society;
    real bp;
    real&lt;lower=0&gt; sigma_society;
  }
  model {
    vector[N] mu;
    target += normal_lpdf(alpha | 0, 10);
    target += normal_lpdf(bp | 0, 1);
    target += cauchy_lpdf(sigma_society | 0, 1);
    target += normal_lpdf(a_society | 0, sigma_society);
    for(i in 1:N) mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
    target += poisson_log_lpmf(T | mu);
  }
  generated quantities {
    vector[N] log_lik;
    {
    vector[N] mu;
    for(i in 1:N) {
      mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
      log_lik[i] = poisson_log_lpmf(T[i] | mu[i]);
    }
    }
  }
&quot;;</code></pre></div><p>Define the Stanmodel and set the output format to :mcmcchain.</p><div><pre><code class="language-julia">stanmodel = Stanmodel(name=&quot;m12.6&quot;,  model=m12_6, output_format=:mcmcchain);</code></pre><pre><code class="language-none">=====&gt; /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12


File /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan will be updated.</code></pre></div><p>Input data for cmdstan</p><div><pre><code class="language-julia">m12_6_data = Dict(&quot;N&quot; =&gt; size(d, 1), &quot;T&quot; =&gt; d[:total_tools], &quot;N_societies&quot; =&gt; 10, &quot;society&quot; =&gt; d[:society], &quot;P&quot; =&gt; d[:population]);</code></pre></div><p>Sample using cmdstan</p><div><pre><code class="language-julia">rc, chn, cnames = stan(stanmodel, m12_6_data, ProjDir, diagnostics=false, summary=false, CmdStanDir=CMDSTAN_HOME);</code></pre><pre><code class="language-none">

--- Translating Stan model to C++ code ---
bin/stanc  /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan --o=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp
Model name=m12_6_model
Input file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan
Output file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp

--- Linking C++ model ---
g++ -Wall -I . -isystem stan/lib/stan_math/lib/eigen_3.3.3 -isystem stan/lib/stan_math/lib/boost_1.66.0 -isystem stan/lib/stan_math/lib/sundials_3.1.0/include -std=c++1y -DBOOST_RESULT_OF_USE_TR1 -DBOOST_NO_DECLTYPE -DBOOST_DISABLE_ASSERTS -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION -Wno-unused-function -Wno-uninitialized -I src -isystem stan/src -isystem stan/lib/stan_math/ -DFUSION_MAX_VECTOR_SIZE=12 -Wno-unused-local-typedefs -DEIGEN_NO_DEBUG -DNO_FPRINTF_OUTPUT -pipe   src/cmdstan/main.cpp  -O3 -o /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6 -include /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_nvecserial.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_cvodes.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_idas.a
Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre></div><p>Describe the draws</p><div><pre><code class="language-julia">describe(chn)</code></pre><pre><code class="language-none">Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                   Mean           SD         Naive SE         MCSE         ESS
         lp__ -39.619444775  3.4413859058 0.054413088850 0.16215042282  450.433394
accept_stat__   0.941186581  0.0827069379 0.001307711510 0.00187595549 1000.000000
   stepsize__   0.049830850  0.0008572483 0.000013554286 0.00013725243   39.009752
  treedepth__   5.919750000  0.4640730314 0.007337638899 0.01659659951  781.869791
 n_leapfrog__  75.395000000 36.2028677995 0.572417600382 0.90168638303 1000.000000
  divergent__   0.000000000  0.0000000000 0.000000000000 0.00000000000         NaN
     energy__  46.227442200  4.3702835029 0.069100249448 0.19420256003  506.418218
        alpha   1.155428355  0.7721977571 0.012209518583 0.02504715872  950.473769
  a_society.1  -0.212866916  0.2482116860 0.003924571348 0.00727609287 1000.000000
  a_society.2   0.033890457  0.2210514103 0.003495129682 0.00530782371 1000.000000
  a_society.3  -0.054753715  0.1922938183 0.003040432229 0.00488785184 1000.000000
  a_society.4   0.320522720  0.1913545198 0.003025580616 0.00485909630 1000.000000
  a_society.5   0.036043350  0.1832357377 0.002897211400 0.00351966178 1000.000000
  a_society.6  -0.324852938  0.2163545315 0.003420865508 0.00552742849 1000.000000
  a_society.7   0.142359411  0.1789768051 0.002829871762 0.00378959928 1000.000000
  a_society.8  -0.169377354  0.1912774318 0.003024361747 0.00372655312 1000.000000
  a_society.9   0.275538909  0.1846066242 0.002918887018 0.00526362576 1000.000000
 a_society.10  -0.079106570  0.3071246518 0.004856067126 0.01025993061  896.067048
           bp   0.255201866  0.0845600206 0.001337011321 0.00280481301  908.913041
sigma_society   0.314956501  0.1404171181 0.002220189579 0.00510568950  756.364804
    log_lik.1  -2.765949342  0.7234686480 0.011439043717 0.01627938693 1000.000000
    log_lik.2  -2.842345610  0.5548476507 0.008772911652 0.01134742091 1000.000000
    log_lik.3  -2.857031828  0.4827672171 0.007633219929 0.01197342538 1000.000000
    log_lik.4  -3.564222610  0.9446688885 0.014936526611 0.02432111300 1000.000000
    log_lik.5  -3.060140205  0.5567808277 0.008803477866 0.01397063566 1000.000000
    log_lik.6  -3.181895530  0.9425962871 0.014903755906 0.02647331591 1000.000000
    log_lik.7  -3.245387277  0.6406234772 0.010129146552 0.01041590315 1000.000000
    log_lik.8  -3.059676988  0.6345413011 0.010032978904 0.01450782286 1000.000000
    log_lik.9  -3.571762600  0.8216605647 0.012991594239 0.01932607201 1000.000000
   log_lik.10  -3.541689200  0.7187261140 0.011364057670 0.01730841589 1000.000000

Quantiles:
                   2.5%         25.0%         50.0%        75.0%         97.5%
         lp__ -47.031832500 -41.618900000 -39.38630000 -37.376650000 -34.02903250
accept_stat__   0.707793150   0.920175250   0.97663150   0.996552000   0.99997402
   stepsize__   0.048768200   0.049259300   0.04972950   0.050301050   0.05109620
  treedepth__   5.000000000   6.000000000   6.00000000   6.000000000   7.00000000
 n_leapfrog__  31.000000000  63.000000000  63.00000000  63.000000000 127.00000000
  divergent__   0.000000000   0.000000000   0.00000000   0.000000000   0.00000000
     energy__  38.708310000  43.299625000  45.91985000  48.965000000  55.45754250
        alpha  -0.354074050   0.714245750   1.16003000   1.622020000   2.66748150
  a_society.1  -0.776559825  -0.352193000  -0.19229600  -0.047494875   0.21948775
  a_society.2  -0.414536900  -0.102267500   0.02778950   0.173596750   0.47414115
  a_society.3  -0.454911475  -0.172022250  -0.04992185   0.068324700   0.31807208
  a_society.4  -0.024253185   0.187826500   0.31284000   0.443509000   0.71750558
  a_society.5  -0.338915800  -0.075687800   0.03264990   0.149998250   0.40211710
  a_society.6  -0.801968350  -0.455567000  -0.30526350  -0.178574750   0.05052158
  a_society.7  -0.190948700   0.023284325   0.13684450   0.253647750   0.51980260
  a_society.8  -0.568665300  -0.288108500  -0.16275300  -0.038327575   0.18861178
  a_society.9  -0.057837812   0.150825250   0.26567800   0.389083750   0.66967760
 a_society.10  -0.688112950  -0.245694000  -0.07420790   0.083187225   0.54819765
           bp   0.086880098   0.206256000   0.25501200   0.304202500   0.41921505
sigma_society   0.109292525   0.221470000   0.29251400   0.382739750   0.64838350
    log_lik.1  -4.675196500  -3.006115000  -2.49457500  -2.270075000  -2.20842975
    log_lik.2  -4.491662750  -2.952225000  -2.62649500  -2.502915000  -2.46848975
    log_lik.3  -4.203901750  -2.970442500  -2.66763000  -2.545770000  -2.51178975
    log_lik.4  -6.126471000  -3.866132500  -3.21521500  -2.897880000  -2.80263925
    log_lik.5  -4.684888000  -3.186630000  -2.83644500  -2.710930000  -2.67005000
    log_lik.6  -5.894628500  -3.515632500  -2.83262000  -2.500197500  -2.39682950
    log_lik.7  -5.050908000  -3.408965000  -2.99607500  -2.823050000  -2.76598950
    log_lik.8  -4.783741750  -3.249167500  -2.80723000  -2.636892500  -2.58844000
    log_lik.9  -5.871773000  -3.845075000  -3.24024000  -2.995607500  -2.92489925
   log_lik.10  -5.648038750  -3.694625000  -3.26372500  -3.099700000  -3.05186975</code></pre></div><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../m12.6.1s/"><span class="direction">Previous</span><span class="title">m12.6.1s</span></a><a class="next" href="../../"><span class="direction">Next</span><span class="title">Functions</span></a></footer></article></body></html>
