<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6.2s · StatisticalRethinking.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>StatisticalRethinking.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><a class="toctext" href="../../layout/">Layout</a></li><li><a class="toctext" href="../../versions/">Versions</a></li><li><a class="toctext" href="../../notes/">Notes</a></li><li><a class="toctext" href="../../acknowledgements/">Acknowledgements</a></li><li><a class="toctext" href="../../references/">References</a></li><li><span class="toctext">Chapter 00</span><ul><li><a class="toctext" href="../../00/clip-01-03/">clip-01-03</a></li><li><a class="toctext" href="../../00/clip-04-05/">clip-04-05</a></li></ul></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/clip-01-02/">clip-01-02</a></li><li><a class="toctext" href="../../02/clip-03-05/">clip-03-05</a></li><li><a class="toctext" href="../../02/clip-06-07/">clip-06-07</a></li><li><a class="toctext" href="../../02/clip-08d/">clip-08d</a></li><li><a class="toctext" href="../../02/clip-08s/">clip-08s</a></li><li><a class="toctext" href="../../02/clip-08t/">clip-08t</a></li></ul></li><li><span class="toctext">Chapter 03</span><ul><li><a class="toctext" href="../../03/clip-01/">clip-01</a></li><li><a class="toctext" href="../../03/clip-02-05/">clip-02-05</a></li><li><a class="toctext" href="../../03/clip-05s/">clip-05s</a></li><li><a class="toctext" href="../../03/clip-06-16s/">clip-06-16s</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.1s/">m4.1s</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.2s/">m4.2s</a></li><li><a class="toctext" href="../../04/m4.2t/">m4.2t</a></li><li><a class="toctext" href="../../04/m4.3s/">m4.3s</a></li><li><a class="toctext" href="../../04/m4.4s/">m4.4s</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li><li><a class="toctext" href="../../04/m4.5d1/">m4.5d1</a></li><li><a class="toctext" href="../../04/m4.5s/">m4.5s</a></li><li><a class="toctext" href="../../04/clip-01-06/">clip-01-06</a></li><li><a class="toctext" href="../../04/clip-07-13s/">clip-07-13s</a></li><li><a class="toctext" href="../../04/clip-14-20/">clip-14-20</a></li><li><a class="toctext" href="../../04/clip-21-23/">clip-21-23</a></li><li><a class="toctext" href="../../04/clip-24-29s/">clip-24-29s</a></li><li><a class="toctext" href="../../04/clip-30s/">clip-30s</a></li><li><a class="toctext" href="../../04/clip-38s/">clip-38s</a></li><li><a class="toctext" href="../../04/clip-43s/">clip-43s</a></li><li><a class="toctext" href="../../04/clip-45-47s/">clip-45-47s</a></li><li><a class="toctext" href="../../04/clip-48-54s/">clip-48-54s</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1s/">m5.1s</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1/">m8.1</a></li><li><a class="toctext" href="../../08/m8.3/">m8.3</a></li></ul></li><li><span class="toctext">Chapter 10</span></li><li><span class="toctext">Chapter 11</span></li><li><span class="toctext">Chapter 12</span><ul><li><a class="toctext" href="../m12.6.1s/">m12.6.1s</a></li><li class="current"><a class="toctext" href>m12.6.2s</a><ul class="internal"></ul></li></ul></li><li><span class="toctext">Chapter 13</span><ul><li><a class="toctext" href="../../13/m13.2s/">m13.2s</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6.2s</a></li></ul><a class="edit-page" href="https://github.com/StanJulia/StatisticalRethinking.jl/blob/master/scripts/12/m12.6.2s.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6.2s</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using StatisticalRethinking
using CmdStan, StanMCMCChain

ProjDir = rel_path(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

d = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(d) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col log_pop, set log() for population data</p><div><pre><code class="language-julia">d[:log_pop] = map((x) -&gt; log(x), d[:population]);
d[:society] = 1:10;

first(d, 5)

m12_6 = &quot;
  data {
    int N;
    int T[N];
    int N_societies;
    int society[N];
    int P[N];
  }
  parameters {
    real alpha;
    vector[N_societies] a_society;
    real bp;
    real&lt;lower=0&gt; sigma_society;
  }
  model {
    vector[N] mu;
    target += normal_lpdf(alpha | 0, 10);
    target += normal_lpdf(bp | 0, 1);
    target += cauchy_lpdf(sigma_society | 0, 1);
    target += normal_lpdf(a_society | 0, sigma_society);
    for(i in 1:N) mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
    target += poisson_log_lpmf(T | mu);
  }
  generated quantities {
    vector[N] log_lik;
    {
    vector[N] mu;
    for(i in 1:N) {
      mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
      log_lik[i] = poisson_log_lpmf(T[i] | mu[i]);
    }
    }
  }
&quot;;</code></pre></div><p>Define the Stanmodel and set the output format to :mcmcchain.</p><div><pre><code class="language-julia">stanmodel = Stanmodel(name=&quot;m12.6&quot;,  model=m12_6, output_format=:mcmcchain);</code></pre><pre><code class="language-none">=====&gt; /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12


File /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan will be updated.</code></pre></div><p>Input data for cmdstan</p><div><pre><code class="language-julia">m12_6_data = Dict(&quot;N&quot; =&gt; size(d, 1), &quot;T&quot; =&gt; d[:total_tools], &quot;N_societies&quot; =&gt; 10, &quot;society&quot; =&gt; d[:society], &quot;P&quot; =&gt; d[:population]);</code></pre></div><p>Sample using cmdstan</p><div><pre><code class="language-julia">rc, chn, cnames = stan(stanmodel, m12_6_data, ProjDir, diagnostics=false, summary=false, CmdStanDir=CMDSTAN_HOME);</code></pre><pre><code class="language-none">

--- Translating Stan model to C++ code ---
bin/stanc  /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan --o=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp
Model name=m12_6_model
Input file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan
Output file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp

--- Linking C++ model ---
g++ -Wall -I . -isystem stan/lib/stan_math/lib/eigen_3.3.3 -isystem stan/lib/stan_math/lib/boost_1.66.0 -isystem stan/lib/stan_math/lib/sundials_3.1.0/include -std=c++1y -DBOOST_RESULT_OF_USE_TR1 -DBOOST_NO_DECLTYPE -DBOOST_DISABLE_ASSERTS -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION -Wno-unused-function -Wno-uninitialized -I src -isystem stan/src -isystem stan/lib/stan_math/ -DFUSION_MAX_VECTOR_SIZE=12 -Wno-unused-local-typedefs -DEIGEN_NO_DEBUG -DNO_FPRINTF_OUTPUT -pipe   src/cmdstan/main.cpp  -O3 -o /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6 -include /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_nvecserial.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_cvodes.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_idas.a
Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre></div><p>Describe the draws</p><div><pre><code class="language-julia">describe(chn)</code></pre><pre><code class="language-none">Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                   Mean           SD         Naive SE         MCSE         ESS
         lp__ -39.271974975  3.4193865669 0.054065248761 0.18768707660  331.915599
accept_stat__   0.941028193  0.0811055322 0.001282391062 0.00126718723 1000.000000
   stepsize__   0.053034325  0.0025438618 0.000040221986 0.00040729297   39.009752
  treedepth__   5.784750000  0.5113538972 0.008085215028 0.02553275297  401.095559
 n_leapfrog__  67.329000000 27.4193310263 0.433537689806 0.91293551602  902.056009
  divergent__   0.000000000  0.0000000000 0.000000000000 0.00000000000         NaN
     energy__  45.666106125  4.2503192423 0.067203447942 0.20623783767  424.723615
        alpha   1.063788370  0.7266167075 0.011488818908 0.02746641898  699.852757
  a_society.1  -0.189509434  0.2359398362 0.003730536365 0.00507253154 1000.000000
  a_society.2   0.053651798  0.2152984662 0.003404167650 0.00604950636 1000.000000
  a_society.3  -0.038751335  0.1890206497 0.002988678890 0.00380702385 1000.000000
  a_society.4   0.330298707  0.1967621872 0.003111083346 0.00730457772  725.592951
  a_society.5   0.050090348  0.1750737988 0.002768159813 0.00427175973 1000.000000
  a_society.6  -0.308201185  0.2073717298 0.003278834942 0.00560705422 1000.000000
  a_society.7   0.144863998  0.1729929330 0.002735258437 0.00464003433 1000.000000
  a_society.8  -0.165113452  0.1774290498 0.002805399603 0.00460857195 1000.000000
  a_society.9   0.269252429  0.1785635371 0.002823337421 0.00542843434 1000.000000
 a_society.10  -0.097849864  0.2781519687 0.004397968784 0.00926023609  902.236013
           bp   0.264641557  0.0782337066 0.001236983513 0.00292261332  716.547681
sigma_society   0.303663062  0.1307366278 0.002067127587 0.00566129698  533.289068
    log_lik.1  -2.751975415  0.6602180477 0.010438963915 0.01557531396 1000.000000
    log_lik.2  -2.820014503  0.5080319365 0.008032690217 0.01317835211 1000.000000
    log_lik.3  -2.859602967  0.4992314699 0.007893542623 0.01054381226 1000.000000
    log_lik.4  -3.597297800  0.9911089267 0.015670808088 0.03060988144 1000.000000
    log_lik.5  -3.027768070  0.5282157456 0.008351824261 0.01336681163 1000.000000
    log_lik.6  -3.223085450  0.9665949610 0.015283208257 0.03426127347  795.943152
    log_lik.7  -3.243812502  0.6247688928 0.009878463562 0.01286078091 1000.000000
    log_lik.8  -3.048987485  0.6051119745 0.009567660394 0.01189088558 1000.000000
    log_lik.9  -3.629819453  0.9151135146 0.014469215119 0.02800917393 1000.000000
   log_lik.10  -3.557131892  0.7156611876 0.011315596929 0.01414863311 1000.000000

Quantiles:
                   2.5%         25.0%         50.0%        75.0%         97.5%
         lp__ -46.294490000 -41.336075000 -39.09185000 -37.137925000 -33.445050000
accept_stat__   0.710214875   0.918099250   0.97586650   0.995580250   0.999965000
   stepsize__   0.050460400   0.050930200   0.05238170   0.054485825   0.056913500
  treedepth__   5.000000000   6.000000000   6.00000000   6.000000000   6.000000000
 n_leapfrog__  31.000000000  63.000000000  63.00000000  63.000000000 127.000000000
  divergent__   0.000000000   0.000000000   0.00000000   0.000000000   0.000000000
     energy__  38.223420000  42.901975000  45.47155000  48.298925000  54.371807500
        alpha  -0.471067325   0.641590500   1.08566500   1.507277500   2.460622750
  a_society.1  -0.699988075  -0.331388250  -0.17024700  -0.028318950   0.230038675
  a_society.2  -0.361483950  -0.079616450   0.04206865   0.179154750   0.514305850
  a_society.3  -0.421759875  -0.158056000  -0.03222985   0.074359825   0.343801250
  a_society.4  -0.013411525   0.190840750   0.31994350   0.451151000   0.745376275
  a_society.5  -0.285789425  -0.063564275   0.04468700   0.156396000   0.417911500
  a_society.6  -0.764657850  -0.432009250  -0.29511800  -0.165513500   0.046884765
  a_society.7  -0.175244500   0.026496125   0.13406800   0.260828750   0.499610275
  a_society.8  -0.545942975  -0.274682500  -0.15430450  -0.042187350   0.159906550
  a_society.9  -0.047790125   0.146754500   0.25979600   0.385204000   0.648122150
 a_society.10  -0.699348925  -0.254155000  -0.08336560   0.065979375   0.464826800
           bp   0.110312550   0.217371000   0.26242200   0.310365000   0.429720600
sigma_society   0.084719288   0.215740250   0.28902200   0.374568500   0.606677275
    log_lik.1  -4.561613500  -2.984255000  -2.50645000  -2.276437500  -2.208629750
    log_lik.2  -4.260503500  -2.931605000  -2.61943000  -2.504817500  -2.468540000
    log_lik.3  -4.272997000  -2.961585000  -2.67330500  -2.547657500  -2.511739750
    log_lik.4  -6.248772500  -3.951810000  -3.21305000  -2.896707500  -2.802120000
    log_lik.5  -4.462464000  -3.127587500  -2.83654000  -2.703247500  -2.670060000
    log_lik.6  -5.856213000  -3.614767500  -2.84881000  -2.509667500  -2.396519500
    log_lik.7  -4.967520500  -3.414235000  -3.00173500  -2.821125000  -2.766029750
    log_lik.8  -4.718130250  -3.236017500  -2.81128500  -2.641517500  -2.588479750
    log_lik.9  -6.253374500  -3.889250000  -3.27562000  -3.001592500  -2.924809250
   log_lik.10  -5.450049250  -3.718132500  -3.28761000  -3.103620000  -3.051989750</code></pre></div><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../m12.6.1s/"><span class="direction">Previous</span><span class="title">m12.6.1s</span></a><a class="next" href="../../13/m13.2s/"><span class="direction">Next</span><span class="title">m13.2s</span></a></footer></article></body></html>
