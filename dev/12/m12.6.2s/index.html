<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6.2s · StatisticalRethinking.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>StatisticalRethinking.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><a class="toctext" href="../../layout/">Layout</a></li><li><a class="toctext" href="../../versions/">Versions</a></li><li><a class="toctext" href="../../notes/">Notes</a></li><li><a class="toctext" href="../../acknowledgements/">Acknowledgements</a></li><li><a class="toctext" href="../../references/">References</a></li><li><span class="toctext">Chapter 00</span><ul><li><a class="toctext" href="../../00/clip-01-03/">clip-01-03</a></li><li><a class="toctext" href="../../00/clip-04-05/">clip-04-05</a></li></ul></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/clip-01-02/">clip-01-02</a></li><li><a class="toctext" href="../../02/clip-03-05/">clip-03-05</a></li><li><a class="toctext" href="../../02/clip-06-07/">clip-06-07</a></li><li><a class="toctext" href="../../02/clip-08d/">clip-08d</a></li><li><a class="toctext" href="../../02/clip-08s/">clip-08s</a></li><li><a class="toctext" href="../../02/clip-08t/">clip-08t</a></li></ul></li><li><span class="toctext">Chapter 03</span><ul><li><a class="toctext" href="../../03/clip-01/">clip-01</a></li><li><a class="toctext" href="../../03/clip-02-05/">clip-02-05</a></li><li><a class="toctext" href="../../03/clip-05s/">clip-05s</a></li><li><a class="toctext" href="../../03/clip-06-16s/">clip-06-16s</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.1s/">m4.1s</a></li><li><a class="toctext" href="../../04/m4.2t/">m4.2t</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li><li><a class="toctext" href="../../04/m4.5s/">m4.5s</a></li><li><a class="toctext" href="../../04/clip-01-06/">clip-01-06</a></li><li><a class="toctext" href="../../04/clip-07-13s/">clip-07-13s</a></li><li><a class="toctext" href="../../04/clip-14-20/">clip-14-20</a></li><li><a class="toctext" href="../../04/clip-21-23/">clip-21-23</a></li><li><a class="toctext" href="../../04/clip-24-29s/">clip-24-29s</a></li><li><a class="toctext" href="../../04/clip-30s/">clip-30s</a></li><li><a class="toctext" href="../../04/clip-38s/">clip-38s</a></li><li><a class="toctext" href="../../04/clip-43s/">clip-43s</a></li><li><a class="toctext" href="../../04/clip-45-47s/">clip-45-47s</a></li><li><a class="toctext" href="../../04/clip-48-54s/">clip-48-54s</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1s/">m5.1s</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li><li><a class="toctext" href="../../05/m5.6s/">m5.6s</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li><li><a class="toctext" href="../../08/m8.1s/">m8.1s</a></li><li><a class="toctext" href="../../08/m8.1t/">m8.1t</a></li><li><a class="toctext" href="../../08/m8.3t/">m8.3t</a></li><li><a class="toctext" href="../../08/m8.5s/">m8.5s</a></li><li><a class="toctext" href="../../08/m8.8s/">m8.8s</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.01s/">m10.01s</a></li><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02s/">m10.02s</a></li></ul></li><li><span class="toctext">Chapter 11</span></li><li><span class="toctext">Chapter 12</span><ul><li><a class="toctext" href="../m12.6.1s/">m12.6.1s</a></li><li class="current"><a class="toctext" href>m12.6.2s</a><ul class="internal"></ul></li></ul></li><li><span class="toctext">Chapter 13</span><ul><li><a class="toctext" href="../../13/m13.2s/">m13.2s</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6.2s</a></li></ul><a class="edit-page" href="https://github.com/StanJulia/StatisticalRethinking.jl/blob/master/scripts/12/m12.6.2s.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6.2s</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using StatisticalRethinking
using CmdStan, StanMCMCChain

ProjDir = rel_path(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

d = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(d) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col log_pop, set log() for population data</p><div><pre><code class="language-julia">d[:log_pop] = map((x) -&gt; log(x), d[:population]);
d[:society] = 1:10;

first(d, 5)

m12_6 = &quot;
  data {
    int N;
    int T[N];
    int N_societies;
    int society[N];
    int P[N];
  }
  parameters {
    real alpha;
    vector[N_societies] a_society;
    real bp;
    real&lt;lower=0&gt; sigma_society;
  }
  model {
    vector[N] mu;
    target += normal_lpdf(alpha | 0, 10);
    target += normal_lpdf(bp | 0, 1);
    target += cauchy_lpdf(sigma_society | 0, 1);
    target += normal_lpdf(a_society | 0, sigma_society);
    for(i in 1:N) mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
    target += poisson_log_lpmf(T | mu);
  }
  generated quantities {
    vector[N] log_lik;
    {
    vector[N] mu;
    for(i in 1:N) {
      mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
      log_lik[i] = poisson_log_lpmf(T[i] | mu[i]);
    }
    }
  }
&quot;;</code></pre></div><p>Define the Stanmodel and set the output format to :mcmcchain.</p><div><pre><code class="language-julia">stanmodel = Stanmodel(name=&quot;m12.6&quot;,  model=m12_6, output_format=:mcmcchain);</code></pre><pre><code class="language-none">=====&gt; /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12


File /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan will be updated.</code></pre></div><p>Input data for cmdstan</p><div><pre><code class="language-julia">m12_6_data = Dict(&quot;N&quot; =&gt; size(d, 1), &quot;T&quot; =&gt; d[:total_tools], &quot;N_societies&quot; =&gt; 10, &quot;society&quot; =&gt; d[:society], &quot;P&quot; =&gt; d[:population]);</code></pre></div><p>Sample using cmdstan</p><div><pre><code class="language-julia">rc, chn, cnames = stan(stanmodel, m12_6_data, ProjDir, diagnostics=false, summary=false, CmdStanDir=CMDSTAN_HOME);</code></pre><pre><code class="language-none">

--- Translating Stan model to C++ code ---
bin/stanc  /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan --o=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp
Model name=m12_6_model
Input file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan
Output file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp

--- Linking C++ model ---
g++ -Wall -I . -isystem stan/lib/stan_math/lib/eigen_3.3.3 -isystem stan/lib/stan_math/lib/boost_1.66.0 -isystem stan/lib/stan_math/lib/sundials_3.1.0/include -std=c++1y -DBOOST_RESULT_OF_USE_TR1 -DBOOST_NO_DECLTYPE -DBOOST_DISABLE_ASSERTS -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION -Wno-unused-function -Wno-uninitialized -I src -isystem stan/src -isystem stan/lib/stan_math/ -DFUSION_MAX_VECTOR_SIZE=12 -Wno-unused-local-typedefs -DEIGEN_NO_DEBUG -DNO_FPRINTF_OUTPUT -pipe   src/cmdstan/main.cpp  -O3 -o /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6 -include /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_nvecserial.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_cvodes.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_idas.a
Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre></div><p>Describe the draws</p><div><pre><code class="language-julia">describe(chn)</code></pre><pre><code class="language-none">Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                   Mean           SD         Naive SE         MCSE         ESS
         lp__ -39.486739225  2.9673919703 0.046918586682 0.08770741769 1000.000000
accept_stat__   0.931459134  0.0930096305 0.001470611383 0.00196724555 1000.000000
   stepsize__   0.053648525  0.0032388326 0.000051210439 0.00051856345   39.009752
  treedepth__   5.827000000  0.4428544118 0.007002143065 0.01259934878 1000.000000
 n_leapfrog__  67.710000000 27.0121142005 0.427099026450 0.66161535033 1000.000000
  divergent__   0.000000000  0.0000000000 0.000000000000 0.00000000000         NaN
     energy__  45.932866650  3.8790072797 0.061332490320 0.11153204852 1000.000000
        alpha   1.099465297  0.7426628621 0.011742530890 0.01951609537 1000.000000
  a_society.1  -0.201883724  0.2428122347 0.003839198527 0.00615793869 1000.000000
  a_society.2   0.039303624  0.2176571209 0.003441461255 0.00514971458 1000.000000
  a_society.3  -0.048728290  0.1994886244 0.003154192102 0.00503710866 1000.000000
  a_society.4   0.326823485  0.1848569978 0.002922845772 0.00504632445 1000.000000
  a_society.5   0.037436189  0.1743556886 0.002756805495 0.00402154865 1000.000000
  a_society.6  -0.325353287  0.1992476411 0.003150381822 0.00439141379 1000.000000
  a_society.7   0.141200702  0.1694588052 0.002679378970 0.00415667737 1000.000000
  a_society.8  -0.180483992  0.1807055662 0.002857205875 0.00329304734 1000.000000
  a_society.9   0.270526208  0.1683860432 0.002662417114 0.00457204818 1000.000000
 a_society.10  -0.102453163  0.2814525465 0.004450155502 0.00733541748 1000.000000
           bp   0.261578499  0.0799567446 0.001264227136 0.00204543043 1000.000000
sigma_society   0.308929099  0.1225371659 0.001937482712 0.00309742717 1000.000000
    log_lik.1  -2.757202405  0.7162596635 0.011325059665 0.01200916639 1000.000000
    log_lik.2  -2.834545290  0.5043500578 0.007974474603 0.01104824364 1000.000000
    log_lik.3  -2.880092433  0.5360567988 0.008475802198 0.01055055775 1000.000000
    log_lik.4  -3.520367037  0.9072843853 0.014345425715 0.01832247877 1000.000000
    log_lik.5  -3.044165262  0.5331018126 0.008429079763 0.01265790467 1000.000000
    log_lik.6  -3.124139828  0.8521527165 0.013473717492 0.01535196304 1000.000000
    log_lik.7  -3.220012748  0.6034035479 0.009540647799 0.01236237868 1000.000000
    log_lik.8  -3.040624677  0.6151116240 0.009725768735 0.01227308481 1000.000000
    log_lik.9  -3.540923905  0.8171645849 0.012920506557 0.01753468786 1000.000000
   log_lik.10  -3.546605065  0.6965151320 0.011012871209 0.01172668997 1000.000000

Quantiles:
                   2.5%         25.0%         50.0%        75.0%         97.5%
         lp__ -46.193552500 -41.347675000 -39.16605000 -37.361100000 -34.628777500
accept_stat__   0.656251350   0.902363750   0.97144550   0.995815750   0.999960050
   stepsize__   0.049966500   0.050670900   0.05371380   0.056691425   0.057200000
  treedepth__   5.000000000   6.000000000   6.00000000   6.000000000   6.000000000
 n_leapfrog__  31.000000000  63.000000000  63.00000000  63.000000000 127.000000000
  divergent__   0.000000000   0.000000000   0.00000000   0.000000000   0.000000000
     energy__  39.362257500  43.153125000  45.56010000  48.362775000  54.536585000
        alpha  -0.517172900   0.666915000   1.12615000   1.566775000   2.521814000
  a_society.1  -0.726530475  -0.350738000  -0.18133750  -0.045452675   0.226414600
  a_society.2  -0.379123300  -0.095452225   0.03681410   0.169865250   0.512595575
  a_society.3  -0.448812650  -0.174069750  -0.04918385   0.079823675   0.351492150
  a_society.4  -0.010299075   0.199780000   0.31874450   0.448539750   0.711367800
  a_society.5  -0.308873675  -0.080453550   0.03967940   0.155660000   0.381904275
  a_society.6  -0.754066000  -0.442875250  -0.31458000  -0.187443750   0.025485333
  a_society.7  -0.179420825   0.030716275   0.13590500   0.247669750   0.484175475
  a_society.8  -0.557572450  -0.293345250  -0.16877450  -0.057918925   0.157939975
  a_society.9  -0.043535475   0.157574750   0.26437700   0.377326250   0.617056975
 a_society.10  -0.701598550  -0.267693500  -0.09448330   0.066882250   0.444137550
           bp   0.111175075   0.211628750   0.25933100   0.308347000   0.431832375
sigma_society   0.124480675   0.225451750   0.29042150   0.370870500   0.606377050
    log_lik.1  -4.762286750  -2.959760000  -2.48744500  -2.278847500  -2.208489500
    log_lik.2  -4.301286500  -2.953422500  -2.63775500  -2.505422500  -2.468590000
    log_lik.3  -4.476842250  -2.981232500  -2.67729500  -2.549120000  -2.511849750
    log_lik.4  -6.021594500  -3.828280000  -3.17194000  -2.885702500  -2.802369250
    log_lik.5  -4.577066250  -3.165270000  -2.84185000  -2.707260000  -2.670219750
    log_lik.6  -5.526244000  -3.449690000  -2.82283500  -2.502560000  -2.396619250
    log_lik.7  -4.953540000  -3.399845000  -2.98758500  -2.813150000  -2.765870000
    log_lik.8  -4.735465250  -3.197825000  -2.81316000  -2.639287500  -2.588440000
    log_lik.9  -5.887156250  -3.777560000  -3.21913500  -2.992317500  -2.924760000
   log_lik.10  -5.568646500  -3.706435000  -3.27077000  -3.103727500  -3.052050000</code></pre></div><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../m12.6.1s/"><span class="direction">Previous</span><span class="title">m12.6.1s</span></a><a class="next" href="../../13/m13.2s/"><span class="direction">Next</span><span class="title">m13.2s</span></a></footer></article></body></html>
