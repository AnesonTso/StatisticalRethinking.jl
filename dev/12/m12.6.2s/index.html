<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6.2s · StatisticalRethinking.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>StatisticalRethinking.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><a class="toctext" href="../../layout/">Layout</a></li><li><a class="toctext" href="../../versions/">Versions</a></li><li><a class="toctext" href="../../notes/">Notes</a></li><li><a class="toctext" href="../../acknowledgements/">Acknowledgements</a></li><li><a class="toctext" href="../../references/">References</a></li><li><span class="toctext">Chapter 00</span><ul><li><a class="toctext" href="../../00/clip-01-03/">clip-01-03</a></li><li><a class="toctext" href="../../00/clip-04-05/">clip-04-05</a></li></ul></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/clip-01-02/">clip-01-02</a></li><li><a class="toctext" href="../../02/clip-03-05/">clip-03-05</a></li><li><a class="toctext" href="../../02/clip-06-07/">clip-06-07</a></li><li><a class="toctext" href="../../02/clip-08d/">clip-08d</a></li><li><a class="toctext" href="../../02/clip-08s/">clip-08s</a></li><li><a class="toctext" href="../../02/clip-08t/">clip-08t</a></li></ul></li><li><span class="toctext">Chapter 03</span><ul><li><a class="toctext" href="../../03/clip-01/">clip-01</a></li><li><a class="toctext" href="../../03/clip-02-05/">clip-02-05</a></li><li><a class="toctext" href="../../03/clip-05s/">clip-05s</a></li><li><a class="toctext" href="../../03/clip-06-16s/">clip-06-16s</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.1s/">m4.1s</a></li><li><a class="toctext" href="../../04/m4.2t/">m4.2t</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li><li><a class="toctext" href="../../04/m4.5s/">m4.5s</a></li><li><a class="toctext" href="../../04/clip-01-06/">clip-01-06</a></li><li><a class="toctext" href="../../04/clip-07-13s/">clip-07-13s</a></li><li><a class="toctext" href="../../04/clip-14-20/">clip-14-20</a></li><li><a class="toctext" href="../../04/clip-21-23/">clip-21-23</a></li><li><a class="toctext" href="../../04/clip-24-29s/">clip-24-29s</a></li><li><a class="toctext" href="../../04/clip-30s/">clip-30s</a></li><li><a class="toctext" href="../../04/clip-38s/">clip-38s</a></li><li><a class="toctext" href="../../04/clip-43s/">clip-43s</a></li><li><a class="toctext" href="../../04/clip-45-47s/">clip-45-47s</a></li><li><a class="toctext" href="../../04/clip-48-54s/">clip-48-54s</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1s/">m5.1s</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li><li><a class="toctext" href="../../05/m5.6s/">m5.6s</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li><li><a class="toctext" href="../../08/m8.1s/">m8.1s</a></li><li><a class="toctext" href="../../08/m8.1t/">m8.1t</a></li><li><a class="toctext" href="../../08/m8.3t/">m8.3t</a></li><li><a class="toctext" href="../../08/m8.5s/">m8.5s</a></li><li><a class="toctext" href="../../08/m8.8s/">m8.8s</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.01s/">m10.01s</a></li><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02s/">m10.02s</a></li><li><a class="toctext" href="../../10/m10.04s/">m10.04s</a></li></ul></li><li><span class="toctext">Chapter 11</span></li><li><span class="toctext">Chapter 12</span><ul><li><a class="toctext" href="../m12.6.1s/">m12.6.1s</a></li><li class="current"><a class="toctext" href>m12.6.2s</a><ul class="internal"></ul></li></ul></li><li><span class="toctext">Chapter 13</span><ul><li><a class="toctext" href="../../13/m13.2s/">m13.2s</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6.2s</a></li></ul><a class="edit-page" href="https://github.com/StanJulia/StatisticalRethinking.jl/blob/master/scripts/12/m12.6.2s.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6.2s</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using StatisticalRethinking
using CmdStan, StanMCMCChain

ProjDir = rel_path(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

d = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(d) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col log_pop, set log() for population data</p><div><pre><code class="language-julia">d[:log_pop] = map((x) -&gt; log(x), d[:population]);
d[:society] = 1:10;

first(d, 5)

m12_6 = &quot;
  data {
    int N;
    int T[N];
    int N_societies;
    int society[N];
    int P[N];
  }
  parameters {
    real alpha;
    vector[N_societies] a_society;
    real bp;
    real&lt;lower=0&gt; sigma_society;
  }
  model {
    vector[N] mu;
    target += normal_lpdf(alpha | 0, 10);
    target += normal_lpdf(bp | 0, 1);
    target += cauchy_lpdf(sigma_society | 0, 1);
    target += normal_lpdf(a_society | 0, sigma_society);
    for(i in 1:N) mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
    target += poisson_log_lpmf(T | mu);
  }
  generated quantities {
    vector[N] log_lik;
    {
    vector[N] mu;
    for(i in 1:N) {
      mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
      log_lik[i] = poisson_log_lpmf(T[i] | mu[i]);
    }
    }
  }
&quot;;</code></pre></div><p>Define the Stanmodel and set the output format to :mcmcchain.</p><div><pre><code class="language-julia">stanmodel = Stanmodel(name=&quot;m12.6&quot;,  model=m12_6, output_format=:mcmcchain);</code></pre><pre><code class="language-none">=====&gt; /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12


File /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan will be updated.</code></pre></div><p>Input data for cmdstan</p><div><pre><code class="language-julia">m12_6_data = Dict(&quot;N&quot; =&gt; size(d, 1), &quot;T&quot; =&gt; d[:total_tools], &quot;N_societies&quot; =&gt; 10, &quot;society&quot; =&gt; d[:society], &quot;P&quot; =&gt; d[:population]);</code></pre></div><p>Sample using cmdstan</p><div><pre><code class="language-julia">rc, chn, cnames = stan(stanmodel, m12_6_data, ProjDir, diagnostics=false, summary=false, CmdStanDir=CMDSTAN_HOME);</code></pre><pre><code class="language-none">

--- Translating Stan model to C++ code ---
bin/stanc  /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan --o=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp
Model name=m12_6_model
Input file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan
Output file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp

--- Linking C++ model ---
g++ -Wall -I . -isystem stan/lib/stan_math/lib/eigen_3.3.3 -isystem stan/lib/stan_math/lib/boost_1.66.0 -isystem stan/lib/stan_math/lib/sundials_3.1.0/include -std=c++1y -DBOOST_RESULT_OF_USE_TR1 -DBOOST_NO_DECLTYPE -DBOOST_DISABLE_ASSERTS -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION -Wno-unused-function -Wno-uninitialized -I src -isystem stan/src -isystem stan/lib/stan_math/ -DFUSION_MAX_VECTOR_SIZE=12 -Wno-unused-local-typedefs -DEIGEN_NO_DEBUG -DNO_FPRINTF_OUTPUT -pipe   src/cmdstan/main.cpp  -O3 -o /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6 -include /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_nvecserial.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_cvodes.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_idas.a
Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre></div><p>Describe the draws</p><div><pre><code class="language-julia">describe(chn)</code></pre><pre><code class="language-none">Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                   Mean          SD         Naive SE        MCSE         ESS
         lp__ -39.631765575  3.131174210 0.049508211279 0.1050035587  889.214277
accept_stat__   0.936861292  0.087393987 0.001381820269 0.0014618896 1000.000000
   stepsize__   0.053044475  0.003385385 0.000053527639 0.0005420277   39.009752
  treedepth__   5.858250000  0.461746944 0.007300860224 0.0170440135  733.946355
 n_leapfrog__  69.712000000 30.145915977 0.476648783189 0.9727689266  960.367799
  divergent__   0.000000000  0.000000000 0.000000000000 0.0000000000         NaN
     energy__  46.118162200  4.014750851 0.063478784636 0.1350335712  883.962193
        alpha   1.058965350  0.764808961 0.012092691464 0.0250423859  932.726955
  a_society.1  -0.199922059  0.233792419 0.003696582726 0.0057716234 1000.000000
  a_society.2   0.055598703  0.225744323 0.003569331146 0.0068611933 1000.000000
  a_society.3  -0.043268004  0.193888544 0.003065647053 0.0044204604 1000.000000
  a_society.4   0.332262247  0.192363082 0.003041527381 0.0061620258  974.532717
  a_society.5   0.047873814  0.180176230 0.002848836343 0.0038961369 1000.000000
  a_society.6  -0.317891800  0.202899326 0.003208120028 0.0048287358 1000.000000
  a_society.7   0.148423711  0.177198183 0.002801749273 0.0046633915 1000.000000
  a_society.8  -0.173492197  0.188847547 0.002985941897 0.0047630925 1000.000000
  a_society.9   0.276132270  0.180089741 0.002847468823 0.0047836926 1000.000000
 a_society.10  -0.106493845  0.310202870 0.004904738036 0.0094772369 1000.000000
           bp   0.265316409  0.083821724 0.001325337831 0.0026778252  979.825492
sigma_society   0.312089320  0.127480337 0.002015641111 0.0046215327  760.876808
    log_lik.1  -2.752959657  0.720378248 0.011390180200 0.0128973101 1000.000000
    log_lik.2  -2.840562387  0.526521743 0.008325039734 0.0098298289 1000.000000
    log_lik.3  -2.868541508  0.502365122 0.007943090007 0.0110345217 1000.000000
    log_lik.4  -3.554767135  0.923704116 0.014605044452 0.0178553684 1000.000000
    log_lik.5  -3.042154190  0.542905200 0.008584084933 0.0123194240 1000.000000
    log_lik.6  -3.148428513  0.894498129 0.014143257251 0.0216961388 1000.000000
    log_lik.7  -3.231890210  0.651365213 0.010298988309 0.0128033083 1000.000000
    log_lik.8  -3.052287853  0.634752560 0.010036319205 0.0133918076 1000.000000
    log_lik.9  -3.548016000  0.828387996 0.013097964274 0.0153962182 1000.000000
   log_lik.10  -3.560349255  0.712943826 0.011272631662 0.0159084978 1000.000000

Quantiles:
                   2.5%         25.0%         50.0%        75.0%         97.5%
         lp__ -46.578702500 -41.565000000 -39.31590000 -37.378575000 -34.42850750
accept_stat__   0.676398350   0.913198000   0.97407650   0.995733250   0.99996200
   stepsize__   0.047220300   0.052680675   0.05468750   0.055051300   0.05558260
  treedepth__   5.000000000   6.000000000   6.00000000   6.000000000   7.00000000
 n_leapfrog__  31.000000000  63.000000000  63.00000000  63.000000000 127.00000000
  divergent__   0.000000000   0.000000000   0.00000000   0.000000000   0.00000000
     energy__  39.209687500  43.268700000  45.72725000  48.743750000  54.68703000
        alpha  -0.586428650   0.628912500   1.08998500   1.518975000   2.51576975
  a_society.1  -0.687659750  -0.340145750  -0.18790700  -0.045254825   0.24908920
  a_society.2  -0.380646375  -0.079235750   0.04769140   0.189746000   0.53809730
  a_society.3  -0.443143725  -0.162467500  -0.04373970   0.077232100   0.34562413
  a_society.4  -0.010503575   0.198283500   0.32390700   0.449408500   0.74699233
  a_society.5  -0.297243625  -0.066065800   0.04440470   0.159588000   0.41116565
  a_society.6  -0.759280450  -0.441421250  -0.29990900  -0.178547500   0.03837839
  a_society.7  -0.166615075   0.030591125   0.13907400   0.253115750   0.53642720
  a_society.8  -0.576769175  -0.288930250  -0.16570350  -0.051838975   0.18751340
  a_society.9  -0.040268905   0.156303500   0.26483200   0.384365250   0.66593448
 a_society.10  -0.767211600  -0.267469500  -0.09362215   0.068579050   0.50929905
           bp   0.103740475   0.214631250   0.26337000   0.311906250   0.44814303
sigma_society   0.120920425   0.224272250   0.29300450   0.378018500   0.61070398
    log_lik.1  -4.859949750  -2.949612500  -2.47558500  -2.271857500  -2.20839925
    log_lik.2  -4.241804250  -2.972525000  -2.63921500  -2.505625000  -2.46858975
    log_lik.3  -4.284002250  -2.986297500  -2.68287500  -2.547792500  -2.51186000
    log_lik.4  -6.180737750  -3.868305000  -3.20728500  -2.899812500  -2.80250925
    log_lik.5  -4.519810750  -3.150810000  -2.83053500  -2.706135000  -2.67018000
    log_lik.6  -5.589150750  -3.460662500  -2.83541500  -2.498400000  -2.39639975
    log_lik.7  -5.083381250  -3.387200000  -2.98199500  -2.813350000  -2.76593000
    log_lik.8  -4.785608000  -3.203895000  -2.81065000  -2.641732500  -2.58854000
    log_lik.9  -5.868759750  -3.790947500  -3.22182500  -2.990037500  -2.92485975
   log_lik.10  -5.535940000  -3.709245000  -3.28731000  -3.098890000  -3.05182000</code></pre></div><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../m12.6.1s/"><span class="direction">Previous</span><span class="title">m12.6.1s</span></a><a class="next" href="../../13/m13.2s/"><span class="direction">Next</span><span class="title">m13.2s</span></a></footer></article></body></html>
