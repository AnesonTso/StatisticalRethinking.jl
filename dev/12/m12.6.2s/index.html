<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6.2s · StatisticalRethinking.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>StatisticalRethinking.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><a class="toctext" href="../../layout/">Layout</a></li><li><a class="toctext" href="../../versions/">Versions</a></li><li><a class="toctext" href="../../notes/">Notes</a></li><li><a class="toctext" href="../../acknowledgements/">Acknowledgements</a></li><li><a class="toctext" href="../../references/">References</a></li><li><span class="toctext">Chapter 00</span><ul><li><a class="toctext" href="../../00/clip-01-03/">clip-01-03</a></li><li><a class="toctext" href="../../00/clip-04-05/">clip-04-05</a></li></ul></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/clip-01-02/">clip-01-02</a></li><li><a class="toctext" href="../../02/clip-03-05/">clip-03-05</a></li><li><a class="toctext" href="../../02/clip-06-07/">clip-06-07</a></li><li><a class="toctext" href="../../02/clip-08d/">clip-08d</a></li><li><a class="toctext" href="../../02/clip-08s/">clip-08s</a></li><li><a class="toctext" href="../../02/clip-08t/">clip-08t</a></li></ul></li><li><span class="toctext">Chapter 03</span><ul><li><a class="toctext" href="../../03/clip-01/">clip-01</a></li><li><a class="toctext" href="../../03/clip-02-05/">clip-02-05</a></li><li><a class="toctext" href="../../03/clip-05s/">clip-05s</a></li><li><a class="toctext" href="../../03/clip-06-16s/">clip-06-16s</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.1s/">m4.1s</a></li><li><a class="toctext" href="../../04/m4.2t/">m4.2t</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li><li><a class="toctext" href="../../04/m4.5s/">m4.5s</a></li><li><a class="toctext" href="../../04/clip-01-06/">clip-01-06</a></li><li><a class="toctext" href="../../04/clip-07-13s/">clip-07-13s</a></li><li><a class="toctext" href="../../04/clip-14-20/">clip-14-20</a></li><li><a class="toctext" href="../../04/clip-21-23/">clip-21-23</a></li><li><a class="toctext" href="../../04/clip-24-29s/">clip-24-29s</a></li><li><a class="toctext" href="../../04/clip-30s/">clip-30s</a></li><li><a class="toctext" href="../../04/clip-38s/">clip-38s</a></li><li><a class="toctext" href="../../04/clip-43s/">clip-43s</a></li><li><a class="toctext" href="../../04/clip-45-47s/">clip-45-47s</a></li><li><a class="toctext" href="../../04/clip-48-54s/">clip-48-54s</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1s/">m5.1s</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li><li><a class="toctext" href="../../05/m5.6s/">m5.6s</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li><li><a class="toctext" href="../../08/m8.1s/">m8.1s</a></li><li><a class="toctext" href="../../08/m8.1t/">m8.1t</a></li><li><a class="toctext" href="../../08/m8.3t/">m8.3t</a></li><li><a class="toctext" href="../../08/m8.5s/">m8.5s</a></li><li><a class="toctext" href="../../08/m8.8s/">m8.8s</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.01s/">m10.01s</a></li><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02s/">m10.02s</a></li><li><a class="toctext" href="../../10/m10.04s/">m10.04s</a></li></ul></li><li><span class="toctext">Chapter 11</span></li><li><span class="toctext">Chapter 12</span><ul><li><a class="toctext" href="../m12.6.1s/">m12.6.1s</a></li><li class="current"><a class="toctext" href>m12.6.2s</a><ul class="internal"></ul></li></ul></li><li><span class="toctext">Chapter 13</span><ul><li><a class="toctext" href="../../13/m13.2s/">m13.2s</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6.2s</a></li></ul><a class="edit-page" href="https://github.com/StanJulia/StatisticalRethinking.jl/blob/master/scripts/12/m12.6.2s.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6.2s</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using StatisticalRethinking
using CmdStan, StanMCMCChain

ProjDir = rel_path(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

d = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(d) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col log_pop, set log() for population data</p><div><pre><code class="language-julia">d[:log_pop] = map((x) -&gt; log(x), d[:population]);
d[:society] = 1:10;

first(d, 5)

m12_6 = &quot;
  data {
    int N;
    int T[N];
    int N_societies;
    int society[N];
    int P[N];
  }
  parameters {
    real alpha;
    vector[N_societies] a_society;
    real bp;
    real&lt;lower=0&gt; sigma_society;
  }
  model {
    vector[N] mu;
    target += normal_lpdf(alpha | 0, 10);
    target += normal_lpdf(bp | 0, 1);
    target += cauchy_lpdf(sigma_society | 0, 1);
    target += normal_lpdf(a_society | 0, sigma_society);
    for(i in 1:N) mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
    target += poisson_log_lpmf(T | mu);
  }
  generated quantities {
    vector[N] log_lik;
    {
    vector[N] mu;
    for(i in 1:N) {
      mu[i] = alpha + a_society[society[i]] + bp * log(P[i]);
      log_lik[i] = poisson_log_lpmf(T[i] | mu[i]);
    }
    }
  }
&quot;;</code></pre></div><p>Define the Stanmodel and set the output format to :mcmcchain.</p><div><pre><code class="language-julia">stanmodel = Stanmodel(name=&quot;m12.6&quot;,  model=m12_6, output_format=:mcmcchain);</code></pre><pre><code class="language-none">=====&gt; /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12


File /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan will be updated.</code></pre></div><p>Input data for cmdstan</p><div><pre><code class="language-julia">m12_6_data = Dict(&quot;N&quot; =&gt; size(d, 1), &quot;T&quot; =&gt; d[:total_tools], &quot;N_societies&quot; =&gt; 10, &quot;society&quot; =&gt; d[:society], &quot;P&quot; =&gt; d[:population]);</code></pre></div><p>Sample using cmdstan</p><div><pre><code class="language-julia">rc, chn, cnames = stan(stanmodel, m12_6_data, ProjDir, diagnostics=false, summary=false, CmdStanDir=CMDSTAN_HOME);</code></pre><pre><code class="language-none">

--- Translating Stan model to C++ code ---
bin/stanc  /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan --o=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp
Model name=m12_6_model
Input file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan
Output file=/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp

--- Linking C++ model ---
g++ -Wall -I . -isystem stan/lib/stan_math/lib/eigen_3.3.3 -isystem stan/lib/stan_math/lib/boost_1.66.0 -isystem stan/lib/stan_math/lib/sundials_3.1.0/include -std=c++1y -DBOOST_RESULT_OF_USE_TR1 -DBOOST_NO_DECLTYPE -DBOOST_DISABLE_ASSERTS -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION -Wno-unused-function -Wno-uninitialized -I src -isystem stan/src -isystem stan/lib/stan_math/ -DFUSION_MAX_VECTOR_SIZE=12 -Wno-unused-local-typedefs -DEIGEN_NO_DEBUG -DNO_FPRINTF_OUTPUT -pipe   src/cmdstan/main.cpp  -O3 -o /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6 -include /home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.hpp stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_nvecserial.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_cvodes.a stan/lib/stan_math/lib/sundials_3.1.0/lib/libsundials_idas.a
Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.

Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.

Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:
Exception: normal_lpdf: Scale parameter is 0, but must be &gt; 0!  (in &#39;/home/travis/build/StanJulia/StatisticalRethinking.jl/docs/build/12/tmp/m12.6.stan&#39; at line 19)

If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,
but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre></div><p>Describe the draws</p><div><pre><code class="language-julia">describe(chn)</code></pre><pre><code class="language-none">Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                   Mean           SD         Naive SE         MCSE         ESS
         lp__ -39.473013650  3.1373906557 0.049606501909 0.08210382188 1000.000000
accept_stat__   0.940439186  0.0821887750 0.001299518636 0.00144424958 1000.000000
   stepsize__   0.052401600  0.0046799208 0.000073996045 0.00074929339   39.009752
  treedepth__   5.857500000  0.4469269358 0.007066535324 0.01604780519  775.607094
 n_leapfrog__  69.943000000 29.7776498083 0.470825983806 0.87531490304 1000.000000
  divergent__   0.000000000  0.0000000000 0.000000000000 0.00000000000         NaN
     energy__  45.970083550  4.0171041069 0.063515992880 0.10048519168 1000.000000
        alpha   1.112899146  0.7120240003 0.011258087948 0.02356396075  913.046054
  a_society.1  -0.208142082  0.2379457639 0.003762252868 0.00503423953 1000.000000
  a_society.2   0.044251459  0.2132949457 0.003372489209 0.00511669984 1000.000000
  a_society.3  -0.046434364  0.1911336984 0.003022089123 0.00393903013 1000.000000
  a_society.4   0.329513461  0.1865105199 0.002948990253 0.00481713738 1000.000000
  a_society.5   0.046870157  0.1757844329 0.002779395925 0.00341507663 1000.000000
  a_society.6  -0.314702349  0.2070384686 0.003273565620 0.00443258546 1000.000000
  a_society.7   0.144769085  0.1756218331 0.002776824997 0.00364716539 1000.000000
  a_society.8  -0.169087995  0.1838182532 0.002906421778 0.00496337008 1000.000000
  a_society.9   0.275109606  0.1743106158 0.002756092831 0.00403243736 1000.000000
 a_society.10  -0.088713135  0.2789652392 0.004410827720 0.00978721197  812.422969
           bp   0.259292098  0.0769507777 0.001216698627 0.00261592273  865.318932
sigma_society   0.307416891  0.1262713847 0.001996525894 0.00320166299 1000.000000
    log_lik.1  -2.751635382  0.6898078981 0.010906820530 0.01792556397 1000.000000
    log_lik.2  -2.817099682  0.5030811459 0.007954411345 0.01139986428 1000.000000
    log_lik.3  -2.854997228  0.5019034327 0.007935790065 0.01046030757 1000.000000
    log_lik.4  -3.532017285  0.8958028919 0.014163887365 0.02051162982 1000.000000
    log_lik.5  -3.049800350  0.5343033431 0.008448077628 0.01004328506 1000.000000
    log_lik.6  -3.191990975  0.9440728298 0.014927102096 0.02092926163 1000.000000
    log_lik.7  -3.254291987  0.6792058343 0.010739187182 0.01220298041 1000.000000
    log_lik.8  -3.049620030  0.6228404634 0.009847972417 0.01021082643 1000.000000
    log_lik.9  -3.567736147  0.8355903916 0.013211844142 0.01843870693 1000.000000
   log_lik.10  -3.542720742  0.6730846563 0.010642402861 0.01383359083 1000.000000

Quantiles:
                   2.5%         25.0%         50.0%        75.0%         97.5%
         lp__ -46.115597500 -41.413825000 -39.23935000 -37.253125000 -34.311425000
accept_stat__   0.704770525   0.915969750   0.97568800   0.995950500   0.999950075
   stepsize__   0.047044900   0.050206825   0.05132015   0.053514925   0.059921200
  treedepth__   5.000000000   6.000000000   6.00000000   6.000000000   7.000000000
 n_leapfrog__  31.000000000  63.000000000  63.00000000  63.000000000 127.000000000
  divergent__   0.000000000   0.000000000   0.00000000   0.000000000   0.000000000
     energy__  39.037342500  43.195575000  45.67330000  48.568525000  54.553095000
        alpha  -0.406051650   0.689581750   1.13466500   1.564092500   2.473123000
  a_society.1  -0.711329450  -0.352973000  -0.19104650  -0.051758875   0.223073300
  a_society.2  -0.385754450  -0.087780025   0.04344815   0.177332250   0.473953800
  a_society.3  -0.437607000  -0.166319500  -0.04505325   0.072815500   0.332224400
  a_society.4  -0.005645712   0.201220500   0.32192800   0.445260250   0.717848450
  a_society.5  -0.288833650  -0.069060050   0.04097210   0.157955750   0.401107825
  a_society.6  -0.766278600  -0.441505750  -0.29531100  -0.174896250   0.040895653
  a_society.7  -0.182681100   0.026288750   0.14071050   0.258907500   0.509391250
  a_society.8  -0.549225800  -0.284691500  -0.16094150  -0.045178025   0.176566475
  a_society.9  -0.049713533   0.158138000   0.26711400   0.380569250   0.637571375
 a_society.10  -0.668247225  -0.254148250  -0.08138900   0.072337375   0.472866100
           bp   0.106203800   0.211695500   0.25631800   0.306222000   0.418339025
sigma_society   0.120853950   0.220751750   0.28771500   0.371856500   0.609407100
    log_lik.1  -4.688143250  -2.978637500  -2.48836500  -2.273277500  -2.208659250
    log_lik.2  -4.256148500  -2.921920000  -2.61933500  -2.502442500  -2.468609750
    log_lik.3  -4.221081000  -2.969375000  -2.66691000  -2.545897500  -2.511749750
    log_lik.4  -6.017337750  -3.841102500  -3.18326500  -2.897877500  -2.802570000
    log_lik.5  -4.547057250  -3.161550000  -2.84472500  -2.709370000  -2.670080000
    log_lik.6  -5.861356250  -3.543710000  -2.85538000  -2.503675000  -2.396549500
    log_lik.7  -5.215853500  -3.422760000  -2.99089000  -2.816742500  -2.765919750
    log_lik.8  -4.783514000  -3.198217500  -2.81339000  -2.639602500  -2.588570000
    log_lik.9  -5.877202000  -3.822292500  -3.24058500  -2.998417500  -2.925160000
   log_lik.10  -5.455628000  -3.714260000  -3.27753000  -3.103505000  -3.052149500</code></pre></div><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../m12.6.1s/"><span class="direction">Previous</span><span class="title">m12.6.1s</span></a><a class="next" href="../../13/m13.2s/"><span class="direction">Next</span><span class="title">m13.2s</span></a></footer></article></body></html>
