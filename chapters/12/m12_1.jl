using StatisticalRethinking
using Turing

Turing.setadbackend(:reverse_diff)

d = CSV.read(joinpath(dirname(Base.pathof(StatisticalRethinking)), "..", "data",
    "reedfrogs.csv"), delim=';')
size(d) # Should be 48x5

# Set number of tanks
d[:tank] = 1:size(d,1)

@model m12_1(density, tank, surv) = begin

    # Number of unique tanks in the data set
    N_tank = length(tank)

    # Set an TArray for the priors/param
    α = Vector{Real}(undef, N_tank)

    # For each tank [1,..,48] set a prior
    for i ∈ 1:length(α)
        α[i] ~ Normal(0,5)
    end

    for i ∈ 1:N_tank
        p = logistic(α[tank[i]])
        surv[i] ~ Binomial(density[i], p)
    end
end

posterior = sample(m12_1(d[:density], d[:tank], d[:surv]),
    Turing.NUTS(2000, 1000, 0.95))
describe(posterior)
#              Mean           SD         Naive SE       MCSE         ESS
   # α[34]    3.501723099  0.704283561 0.01574825918 0.1406832955   25.061672
   # α[48]   -0.185552314  0.248710803 0.00556134261 0.0421594919   34.801548
   # α[40]    2.703445981  0.628604658 0.01405602747 0.1257173278   25.001433
   #  α[4]    6.876284983  1.671306959 0.03737155972 0.2791699330   35.840591
   # α[25]   -1.277947748  0.407213948 0.00910558069 0.0677444226   36.132516
   # α[22]    2.772173673  0.468302808 0.01047156914 0.0827143912   32.054674
   # α[28]   -0.796666883  0.524359838 0.01172504243 0.1064366961   24.270352
   #  α[5]    1.712265645  1.215879909 0.02718790129 0.2676780831   20.632685
   # α[16]    1.914984444  0.510546006 0.01141615576 0.0912003088   31.338424
   # α[42]   -0.676437850  0.419370084 0.00937740016 0.0871129493   23.175518
   # α[21]    2.774667290  0.684776689 0.01531207225 0.1422112273   23.186231
   # α[46]   -0.575309357  0.296896710 0.00663881225 0.0527865057   31.634789
   # α[26]    0.069568520  0.416424064 0.00931152515 0.0750549098   30.783176
   # α[10]    2.197897853  0.688164757 0.01538783176 0.1373934434   25.087237
   # α[11]    0.834342336  0.709142178 0.01585690117 0.1485349245   22.793419
   #  α[8]    2.233546540  0.751202093 0.01679738944 0.1583766442   22.497347
   # α[24]    1.638956114  0.569818278 0.01274152405 0.1166751885   23.851502
   #  α[9]   -0.347657582  0.400718042 0.00896032782 0.0683832900   34.338223
   # α[44]   -0.311373834  0.376105893 0.00840998343 0.0679402644   30.645436
   # α[27]   -1.533550623  0.436598555 0.00976264047 0.0814754975   28.715114
   # α[20]    5.855173998  1.023556277 0.02288741414 0.1983647772   26.625289
   # α[45]    0.503079655  0.353239629 0.00789867822 0.0636460821   30.803175
   # α[38]    9.241673662  1.346345710 0.03010520529 0.2823824688   22.732004
   # α[14]   -0.032063278  0.448081353 0.01001940366 0.0809799176   30.616750
   # α[36]    2.133397574  0.369203214 0.00825563484 0.0666010768   30.730416
   # α[18]    2.607552554  0.527380565 0.01179258792 0.0927904097   32.302940
   # α[37]    2.257825837  0.432629653 0.00967389314 0.0818487965   27.938814
   # α[17]    4.111265989  0.534940693 0.01196163753 0.0994725714   28.920419
   # α[30]    1.414874356  0.495160769 0.01107213139 0.1046785706   22.375713
   # α[31]   -0.708585729  0.427086282 0.00954993959 0.0788397696   29.345435
   # α[39]    2.222491292  0.589776755 0.01318780917 0.1240396332   22.607595
   # α[33]    3.419002750  0.922892014 0.02063649278 0.1924400508   22.999100
   # α[41]   -2.205450846  0.563267913 0.01259505343 0.1099121047   26.262676
   #  α[7]    3.027292308  1.495941288 0.03345026409 0.2999860381   24.867207
   #  α[6]    2.240022885  1.079689280 0.02414258624 0.2300849552   22.020194
   # α[23]    2.573770671  0.736316756 0.01646454318 0.1543483650   22.757539
   # α[29]    0.115838412  0.262966162 0.00588010213 0.0386981091   46.176419
   # α[47]    2.001752969  0.503201595 0.01125192973 0.0954286271   27.805241
   # α[43]   -0.676833883  0.342031373 0.00764805400 0.0550954773   38.538960
   # α[15]    2.298646610  0.681881840 0.01524734148 0.1369760990   24.781561
   #  α[2]   10.315266394  1.544701756 0.03454058132 0.3170556409   23.736589


# Rethinking
#             mean   sd  5.5% 94.5% n_eff Rhat
# a_tank[1]   2.49 1.16  0.85  4.53  1079    1
# a_tank[2]   5.69 2.75  2.22 10.89  1055    1
# a_tank[3]   0.89 0.75 -0.23  2.16  1891    1
# a_tank[4]   5.71 2.70  2.21 10.85   684    1
# a_tank[5]   2.52 1.14  0.92  4.42  1640    1
# a_tank[6]   2.49 1.13  0.94  4.52  1164    1
# a_tank[7]   5.74 2.71  2.25 10.86   777    1
# a_tank[8]   2.52 1.19  0.95  4.42  1000    1
# a_tank[9]  -0.46 0.69 -1.62  0.55  2673    1
# a_tank[10]  2.53 1.19  0.93  4.59  1430    1
# a_tank[11]  0.93 0.72 -0.17  2.11  1387    1
# a_tank[12]  0.47 0.74 -0.63  1.70  1346    1
# a_tank[13]  0.91 0.76 -0.25  2.30  1559    1
# a_tank[14]  0.00 0.66 -1.04  1.06  2085    1
# a_tank[15]  2.50 1.19  0.95  4.40  1317    1
# a_tank[16]  2.50 1.14  0.98  4.31  1412    1
# a_tank[17]  3.49 1.12  1.94  5.49   945    1
# a_tank[18]  2.59 0.75  1.50  3.81  1561    1
# a_tank[19]  2.11 0.64  1.15  3.15  1712    1
# a_tank[20]  6.40 2.57  3.11 11.04   996    1
# a_tank[21]  2.59 0.74  1.54  3.93  1233    1
# a_tank[22]  2.63 0.79  1.49  4.01  1184    1
# a_tank[23]  2.64 0.83  1.45  4.13  1379    1
# a_tank[24]  1.74 0.59  0.85  2.72  1736    1
# a_tank[25] -1.19 0.45 -1.90 -0.50  2145    1
# a_tank[26]  0.09 0.41 -0.53  0.78  2167    1
# a_tank[27] -1.75 0.56 -2.65 -0.88  1666    1
# a_tank[28] -0.58 0.43 -1.25  0.08  1567    1
# a_tank[29]  0.08 0.39 -0.54  0.71  3053    1
# a_tank[30]  1.43 0.49  0.66  2.24  2754    1
# a_tank[31] -0.79 0.44 -1.50 -0.12  1299    1
# a_tank[32] -0.42 0.41 -1.12  0.23  1661    1
# a_tank[33]  3.84 1.08  2.31  5.70   808    1
# a_tank[34]  3.00 0.85  1.83  4.36  1038    1
# a_tank[35]  2.96 0.82  1.82  4.25  1578    1
# a_tank[36]  2.14 0.55  1.31  3.08  1734    1
# a_tank[37]  2.12 0.56  1.31  3.04  1131    1
# a_tank[38]  6.72 2.62  3.45 11.44   706    1
# a_tank[39]  2.95 0.73  1.85  4.08  1509    1
# a_tank[40]  2.48 0.65  1.53  3.61  1731    1
# a_tank[41] -2.15 0.57 -3.11 -1.29  1231    1
# a_tank[42] -0.67 0.35 -1.22 -0.14  1444    1
# a_tank[43] -0.54 0.35 -1.12  0.03  1776    1
# a_tank[44] -0.43 0.34 -1.00  0.10  1735    1
# a_tank[45]  0.54 0.36 -0.04  1.14  1376    1
# a_tank[46] -0.67 0.34 -1.25 -0.15  1619    1
# a_tank[47]  2.14 0.55  1.31  3.04  1916    1
# a_tank[48] -0.06 0.35 -0.61  0.50  1932    1
