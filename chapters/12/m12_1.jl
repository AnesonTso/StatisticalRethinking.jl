using StatisticalRethinking
using Turing
using StatsFuns #logistic

Turing.setadbackend(:reverse_diff)

d = CSV.read(joinpath(dirname(Base.pathof(StatisticalRethinking)), "..", "data",
    "reedfrogs.csv"), delim=';')
size(d) # Should be 48x5

# Set number of tanks
d[:tank] = 1:size(d,1)

@model m12_1(density, tank, surv) = begin

    # Number of unique tanks in the data set
    N_tank = length(tank)

    # Set an TArray for the priors/param
    α = TArray{Any}(undef, N_tank)

    # For each tank [1,..,48] set a prior
    for i ∈ 1:length(α)
        α[i] ~ Normal(0,5)
    end

    for i ∈ 1:length(N_tank)
        p = logistic(α[tank[i]])
        surv[i] ~ Binomial(density[i], p)
    end
end

posterior = sample(m12_1(d[:density], d[:tank], d[:surv]),
    Turing.NUTS(2000, 1000, 0.95))
describe(posterior)
#              Mean           SD       Naive SE       MCSE         ESS
   # α[34]    1.887117214  5.08715201 0.1137521770 0.9234513389   30.347394
   # α[48]    2.583032929  3.18784658 0.0712824165 0.4283220218   55.392889
   # α[40]   -1.289332366  3.21277987 0.0718399419 0.3212890055   99.993141
   #  α[4]   -2.169923818  3.54127017 0.0791852082 0.5031954400   49.527309
   # α[25]   -0.838848300  3.49703429 0.0781960640 0.5365039164   42.486797
   # α[22]    3.679342941  3.72919333 0.0833872980 0.6134794912   36.951298
   #  α[5]    1.684997605  3.23393943 0.0723130839 0.4830199203   44.826381
   # α[28]    0.206264557  4.26500972 0.0953685166 0.7603831903   31.461182
   # α[16]   -0.208481623  3.22595779 0.0721346091 0.5031062944   41.114769
   # α[42]   -0.455860065  3.70772396 0.0829072281 0.5644982255   43.140942
   # α[21]   -0.601042134  5.48511987 0.1226510089 1.0787640991   25.853496
   # α[46]    2.226589912  4.34358277 0.0971254633 0.8127709829   28.560106
   # α[26]    0.974336885  4.83869683 0.1081965504 0.9147449678   27.980583
   # α[10]   -2.233688010  3.70790979 0.0829113835 0.5877345957   39.801167
   # α[11]    1.780183150  3.91228803 0.0874814199 0.6854547864   32.576470
   #  α[8]   -1.737484689  2.78766442 0.0623340714 0.3701338386   56.723550
   # α[24]   -3.209512744  3.87216059 0.0865841429 0.7194972450   28.963327
   #  α[9]   -2.519214417  4.76266801 0.1064964943 0.8994364831   28.038813
   # α[44]    0.325543074  3.47641322 0.0777349628 0.5717308930   36.972555
   # α[27]    0.725054643  3.15246820 0.0704913318 0.5470206165   33.211924
   # α[20]    3.926032966  3.61065220 0.0807366376 0.5753485147   39.383048
   # α[45]   -3.933712707  4.60180637 0.1028995186 0.8585808887   28.727263
   # α[38]    2.536098619  3.38853317 0.0757699052 0.4341585280   60.915359
   # α[14]   -2.424847683  3.91468979 0.0875351247 0.6743792611   33.696616
   # α[18]   -2.219663034  3.40676580 0.0761775991 0.4821607328   49.923023
   # α[36]   -0.872352064  3.61804334 0.0809019085 0.5206094697   48.297361
   # α[37]    0.307153262  3.26449936 0.0729964247 0.4874145307   44.857620
   # α[30]   -3.917397463  3.89082347 0.0870014576 0.6289017419   38.275199
   # α[17]    0.835733033  3.95008249 0.0883265296 0.6443964327   37.575613
   # α[39]    1.215963307  3.00055359 0.0670944179 0.3989746426   56.560363
   # α[31]   -0.252183827  4.53668917 0.1014434538 0.8366894731   29.400143
   # α[33]   -0.893635963  4.76982986 0.1066566382 0.8690624826   30.123385
   # α[41]    1.020355912  3.62198288 0.0809899993 0.5444012913   44.264391
   #  α[7]    1.164787260  3.38814632 0.0757612548 0.6179513356   30.061854
   #  α[6]    1.988296805  3.12888133 0.0699639134 0.3946003912   62.872852
   # α[23]    3.735943217  3.54074109 0.0791733777 0.6383386967   30.767060
   # α[29]   -4.124685785  4.44707225 0.0994395586 0.8375506998   28.192018
   # α[47]   -1.594886142  3.60832453 0.0806845894 0.4472046531   65.102633
   # α[43]    1.165512623  3.63461687 0.0812725040 0.4746238461   58.643268
   # α[15]   -1.912652015  3.41014539 0.0762531690 0.5555795331   37.675005
   #  α[2]   -0.083010752  3.95789533 0.0885012300 0.6687989180   35.021721
   # α[13]    0.688001424  3.29486366 0.0736753912 0.4552601489   52.378810
   # α[1]    2.320464588  0.97064127 0.0217041986 0.0726605870  178.451294
   # α[32]   -2.520596047  4.21381018 0.0942236602 0.7214047235   34.118661
   #  α[3]    1.751750602  3.83997077 0.0858643568 0.6318187767   36.937779
   # α[12]    1.929154265  3.20049179 0.0715651721 0.4782340424   44.787050
   # α[19]    3.892630989  3.46355524 0.0774474495 0.5401660101   41.114000
   # α[35]   -0.564295619  4.83743767 0.1081683946 0.8877450123   29.693014


# Rethinking
#             mean   sd  5.5% 94.5% n_eff Rhat
# a_tank[1]   2.49 1.16  0.85  4.53  1079    1
# a_tank[2]   5.69 2.75  2.22 10.89  1055    1
# a_tank[3]   0.89 0.75 -0.23  2.16  1891    1
# a_tank[4]   5.71 2.70  2.21 10.85   684    1
# a_tank[5]   2.52 1.14  0.92  4.42  1640    1
# a_tank[6]   2.49 1.13  0.94  4.52  1164    1
# a_tank[7]   5.74 2.71  2.25 10.86   777    1
# a_tank[8]   2.52 1.19  0.95  4.42  1000    1
# a_tank[9]  -0.46 0.69 -1.62  0.55  2673    1
# a_tank[10]  2.53 1.19  0.93  4.59  1430    1
# a_tank[11]  0.93 0.72 -0.17  2.11  1387    1
# a_tank[12]  0.47 0.74 -0.63  1.70  1346    1
# a_tank[13]  0.91 0.76 -0.25  2.30  1559    1
# a_tank[14]  0.00 0.66 -1.04  1.06  2085    1
# a_tank[15]  2.50 1.19  0.95  4.40  1317    1
# a_tank[16]  2.50 1.14  0.98  4.31  1412    1
# a_tank[17]  3.49 1.12  1.94  5.49   945    1
# a_tank[18]  2.59 0.75  1.50  3.81  1561    1
# a_tank[19]  2.11 0.64  1.15  3.15  1712    1
# a_tank[20]  6.40 2.57  3.11 11.04   996    1
# a_tank[21]  2.59 0.74  1.54  3.93  1233    1
# a_tank[22]  2.63 0.79  1.49  4.01  1184    1
# a_tank[23]  2.64 0.83  1.45  4.13  1379    1
# a_tank[24]  1.74 0.59  0.85  2.72  1736    1
# a_tank[25] -1.19 0.45 -1.90 -0.50  2145    1
# a_tank[26]  0.09 0.41 -0.53  0.78  2167    1
# a_tank[27] -1.75 0.56 -2.65 -0.88  1666    1
# a_tank[28] -0.58 0.43 -1.25  0.08  1567    1
# a_tank[29]  0.08 0.39 -0.54  0.71  3053    1
# a_tank[30]  1.43 0.49  0.66  2.24  2754    1
# a_tank[31] -0.79 0.44 -1.50 -0.12  1299    1
# a_tank[32] -0.42 0.41 -1.12  0.23  1661    1
# a_tank[33]  3.84 1.08  2.31  5.70   808    1
# a_tank[34]  3.00 0.85  1.83  4.36  1038    1
# a_tank[35]  2.96 0.82  1.82  4.25  1578    1
# a_tank[36]  2.14 0.55  1.31  3.08  1734    1
# a_tank[37]  2.12 0.56  1.31  3.04  1131    1
# a_tank[38]  6.72 2.62  3.45 11.44   706    1
# a_tank[39]  2.95 0.73  1.85  4.08  1509    1
# a_tank[40]  2.48 0.65  1.53  3.61  1731    1
# a_tank[41] -2.15 0.57 -3.11 -1.29  1231    1
# a_tank[42] -0.67 0.35 -1.22 -0.14  1444    1
# a_tank[43] -0.54 0.35 -1.12  0.03  1776    1
# a_tank[44] -0.43 0.34 -1.00  0.10  1735    1
# a_tank[45]  0.54 0.36 -0.04  1.14  1376    1
# a_tank[46] -0.67 0.34 -1.25 -0.15  1619    1
# a_tank[47]  2.14 0.55  1.31  3.04  1916    1
# a_tank[48] -0.06 0.35 -0.61  0.50  1932    1
