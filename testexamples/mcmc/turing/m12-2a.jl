using StatisticalRethinking

Turing.setadbackend(:reverse_diff)

d = CSV.read(joinpath(dirname(Base.pathof(StatisticalRethinking)), "..", "data",
    "reedfrogs.csv"), delim=';')
size(d) # Should be 48x5

# Set number of tanks
d[:tank] = 1:size(d,1)

@model m12_2(density, tank, surv) = begin

    # Separate priors on α and σ for each tank
    σ ~ Truncated(Cauchy(0,1), 0, Inf)
    α ~ Normal(0,1) #Check stancode this might need to be in the for loop below?

    # Number of unique tanks in the data set
    N_tank = length(tank)

    # Set an TArray for the priors/param
    a_tank = Vector{Real}(undef, N_tank)

    # For each tank [1,..,48] set a prior
    for i ∈ 1:length(a_tank)
        a_tank[i] ~ Normal(α,σ)
    end

    for i ∈ 1:N_tank
        p = logistic(a_tank[tank[i]])
        surv[i] ~ Binomial(density[i], p)
    end
end

posterior = sample(m12_2(d[:density], d[:tank], d[:surv]),
    Turing.NUTS(4000, 2000, 0.99))

describe(posterior)

#               Mean           SD        Naive SE       MCSE         ESS
#          α    1.395449327  0.240019400 0.0037950399 0.0325867460   54.251369
#          σ    1.792430141  0.182498543 0.0028855553 0.0174332091  109.588284
#  a_tank[1]    1.392430980  0.725565735 0.0114722016 0.1122910277   41.750667
#  a_tank[2]    2.689788036  0.358266520 0.0056646911 0.0460072471   60.640106
#  a_tank[3]    1.816505224  0.815482571 0.0128939116 0.1281421425   40.499103
#  a_tank[4]    2.406018668  0.642875681 0.0101647570 0.0979021333   43.119100
#  a_tank[5]    2.212015582  0.842043123 0.0133138708 0.1310882582   41.261127
#  a_tank[6]    1.872912930  0.384866394 0.0060852720 0.0564335506   46.509881
#  a_tank[7]    2.801079745  0.602741732 0.0095301836 0.0901026168   44.749451
#  a_tank[8]    3.170343994  0.363890140 0.0057536083 0.0510018441   50.905982
#  a_tank[9]   -0.589257559  0.341167995 0.0053943397 0.0473690303   51.873742
# a_tank[10]    3.508130344  0.466163644 0.0073706944 0.0657503277   50.266767
# a_tank[11]    0.610735680  0.314998541 0.0049805642 0.0428148989   54.128655
# a_tank[12]   -0.556350070  0.378280910 0.0059811464 0.0559083577   45.779957
# a_tank[13]    2.037562339  0.712058651 0.0112586358 0.1088703132   42.777223
# a_tank[14]    0.418198333  0.289082407 0.0045707942 0.0385616921   56.199333
# a_tank[15]    1.694239848  0.790124232 0.0124929610 0.1232192195   41.118177
# a_tank[16]    1.615351269  0.325819578 0.0051516599 0.0456435250   50.956079
# a_tank[17]    2.957276876  0.561507914 0.0088782197 0.0843518956   44.312073
# a_tank[18]    2.664389110  0.526809874 0.0083295955 0.0790147565   44.452010
# a_tank[19]    1.906185304  0.247640766 0.0039155443 0.0306520937   65.271559
# a_tank[20]    4.526200894  0.433246847 0.0068502341 0.0580651577   55.672356
# a_tank[21]    1.953336502  0.280851426 0.0044406509 0.0372164788   56.948554
# a_tank[22]    3.192354738  0.424967532 0.0067193267 0.0641614582   43.869537
# a_tank[23]    2.707167759  0.409292696 0.0064714857 0.0589470021   48.210823
# a_tank[24]    2.350557679  0.392864654 0.0062117356 0.0592982487   43.893699
# a_tank[25]   -1.274575556  0.325387266 0.0051448244 0.0474869248   46.951883
# a_tank[26]   -0.154058436  0.254376437 0.0040220446 0.0341213343   55.577851
# a_tank[27]   -1.971383589  0.421513998 0.0066647215 0.0621760211   45.959802
# a_tank[28]   -0.883834303  0.380917369 0.0060228324 0.0558201165   46.567194
# a_tank[29]    0.128554291  0.522455657 0.0082607493 0.0816224825   40.971255
# a_tank[30]    1.708410417  0.243825728 0.0038552233 0.0343392263   50.417122
# a_tank[31]   -0.643973684  0.198129622 0.0031327044 0.0234737738   71.241489
# a_tank[32]    0.113476268  0.430927063 0.0068135551 0.0656153721   43.131677
# a_tank[33]    4.429615273  0.466454888 0.0073752994 0.0688495612   45.900450
# a_tank[34]    3.295352918  0.260700570 0.0041220379 0.0347205980   56.377987
# a_tank[35]    2.226146155  0.430578348 0.0068080415 0.0646837434   44.311258
# a_tank[36]    1.905072685  0.560428296 0.0088611494 0.0869795256   41.515095
# a_tank[37]    2.045235375  0.224190263 0.0035447593 0.0303181390   54.679988
# a_tank[38]    5.277004048  0.851886024 0.0134695007 0.1311828330   42.170522
# a_tank[39]    1.691324721  0.623880836 0.0098644221 0.0959970028   42.23650
# a_tank[40]    2.541356198  0.365342491 0.0057765720 0.0527281210   48.008240
# a_tank[41]   -1.810007855  0.302368063 0.0047808589 0.0424483957   50.739861
# a_tank[42]   -0.600581765  0.223476202 0.0035334690 0.0286332895   60.914415
# a_tank[43]   -0.750904573  0.225017309 0.0035578360 0.0285281187   62.213636
# a_tank[44]   -0.122601596  0.223661935 0.0035364057 0.0320501129   48.699559
# a_tank[45]    0.358546430  0.150903816 0.0023859988 0.0190851839   62.518384
# a_tank[46]   -0.236483293  0.280119871 0.0044290840 0.0400092746   49.019229
# a_tank[47]    2.127026056  0.430740807 0.0068106102 0.0641652255   45.064295
# a_tank[48]    0.135823558  0.375680258 0.0059400264 0.0545007634   47.515092

#Rethinking
#            mean   sd  5.5% 94.5% n_eff Rhat
# a           1.30 0.25  0.90  1.70 11662    1
# sigma       1.62 0.22  1.30  1.99  6556    1
# a_tank[1]   2.12 0.88  0.84  3.60 16091    1
# a_tank[2]   3.05 1.10  1.52  4.92 10962    1
# a_tank[3]   1.00 0.66 -0.02  2.10 18175    1
# a_tank[4]   3.05 1.11  1.47  4.96 10181    1
# a_tank[5]   2.13 0.87  0.85  3.62 13720    1
# a_tank[6]   2.12 0.86  0.86  3.59 11628    1
# a_tank[7]   3.07 1.13  1.47  5.03 10315    1
# a_tank[8]   2.13 0.87  0.86  3.60 13754    1
# a_tank[9]  -0.18 0.60 -1.14  0.76 18218    1
# a_tank[10]  2.11 0.86  0.83  3.58 15121    1
# a_tank[11]  1.00 0.67 -0.04  2.09 17390    1
# a_tank[12]  0.58 0.62 -0.41  1.60 17209    1
# a_tank[13]  0.99 0.66 -0.04  2.09 15225    1
# a_tank[14]  0.19 0.62 -0.79  1.20 18293    1
# a_tank[15]  2.13 0.89  0.83  3.63 12445    1
# a_tank[16]  2.11 0.87  0.87  3.61 12385    1
# a_tank[17]  2.89 0.80  1.76  4.29 12583    1
# a_tank[18]  2.38 0.66  1.43  3.49 14437    1
# a_tank[19]  2.00 0.58  1.12  2.99 13959    1
# a_tank[20]  3.67 1.03  2.20  5.44 10629    1
# a_tank[21]  2.38 0.65  1.42  3.47 15309    1
# a_tank[22]  2.39 0.66  1.42  3.49 13614    1
# a_tank[23]  2.40 0.67  1.41  3.53 11868    1
# a_tank[24]  1.69 0.52  0.90  2.55 18468    1
# a_tank[25] -1.00 0.45 -1.74 -0.30 18153    1
# a_tank[26]  0.16 0.40 -0.47  0.81 21895    1
# a_tank[27] -1.44 0.50 -2.28 -0.69 16718    1
# a_tank[28] -0.47 0.41 -1.15  0.17 20160    1
# a_tank[29]  0.15 0.40 -0.48  0.80 19401    1
# a_tank[30]  1.44 0.49  0.70  2.24 15407    1
# a_tank[31] -0.64 0.42 -1.33 -0.01 15356    1
# a_tank[32] -0.31 0.40 -0.95  0.32 19130    1
# a_tank[33]  3.18 0.78  2.06  4.55 10894    1
# a_tank[34]  2.70 0.66  1.75  3.84 13573    1
# a_tank[35]  2.69 0.64  1.74  3.78 13876    1
# a_tank[36]  2.06 0.53  1.26  2.92 16329    1
# a_tank[37]  2.06 0.51  1.29  2.91 14672    1
# a_tank[38]  3.88 0.97  2.52  5.57  9349    1
# a_tank[39]  2.70 0.64  1.77  3.78 13444    1
# a_tank[40]  2.34 0.56  1.49  3.31 14966    1
# a_tank[41] -1.82 0.48 -2.61 -1.10 14214    1
# a_tank[42] -0.58 0.36 -1.16 -0.02 17203    1
# a_tank[43] -0.46 0.35 -1.02  0.08 17762    1
# a_tank[44] -0.34 0.34 -0.90  0.20 16740    1
# a_tank[45]  0.58 0.35  0.02  1.14 18946    1
# a_tank[46] -0.57 0.34 -1.13 -0.03 19761    1
# a_tank[47]  2.05 0.51  1.30  2.90 15122    1
# a_tank[48]  0.00 0.33 -0.53  0.53 18236    1
